---
title: "HCP BMI"
output:
  html_document:
    df_print: paged
---

# Libraries
```{r, echo=FALSE}
library(tidyverse)
library(magrittr)
library(purrr)
library(plyr)
library(ggplot2)
library(data.table)
library(dplyr)
# library(formattable)
library(gplots)
library(lm.beta)
library(mgcv)
library(lsmeans)
library(psych)
library(multcomp)
library(gridExtra)
library(grid)
library(nlme)
```


# Functions
```{r, echo=FALSE}
cbPalette <- c( "#E69F00", "#56B4E9",  "#CC79A7")
violin <- function(d, x, y){
  plot1<-ggplot(d, aes(factor(x), y)) + 
    geom_violin(aes(fill = x),stat = "ydensity",draw_quantiles = c(0.25, 0.5, 0.75))+scale_fill_manual(values=cbPalette)+theme_classic()
  return(plot1)
}
```

#  Loading in the data
## Demographics
```{r, echo=FALSE}
demos<-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/demos.csv", header=T, sep=",")
head(demos)
demos$Age_c<-scale(demos$Age_in_Yrs, scale = FALSE)
demos$HBA1c_c<-scale(demos$HbA1C, scale = FALSE)
demos$group <- ordered(demos$group, levels = c("no", "ov", "ob"))

demos$race_eth[demos$Race == "White" & demos$Ethnicity == "Hispanic/Latino" ] <- "White and Hispanic"
demos$race_eth[demos$Race == "Black or African Am." & demos$Ethnicity =="Hispanic/Latino" ] <- "Black or African American and Hispanic"
demos$race_eth[demos$Race == "Am. Indian/Alaskan Nat." & demos$Ethnicity =="Hispanic/Latino" ] <- "Native American and Hispanic"
demos$race_eth[demos$Race == "Asian/Nat. Hawaiian/Othr Pacific Is." & demos$Ethnicity =="Hispanic/Latino" ] <- "Asian and Hispanic"
demos$race_eth[demos$Race == "More than one" & demos$Ethnicity =="Hispanic/Latino" ] <- "Multi-racial and Hispanic"
demos$race_eth[demos$Race == "Unknown or Not Reported" & demos$Ethnicity =="Hispanic/Latino" ] <- "Unknown or not reported and Hispanic"

demos$race_eth[demos$Race == "White" &demos$Ethnicity == "Not Hispanic/Latino"] <- "White"
demos$race_eth[demos$Race == "Black or African Am." & demos$Ethnicity =="Not Hispanic/Latino" ] <- "Black or African American"
demos$race_eth[demos$Race == "Am. Indian/Alaskan Nat." & demos$Ethnicity =="Not Hispanic/Latino" ] <- "Native American"
demos$race_eth[demos$Race == "Asian/Nat. Hawaiian/Othr Pacific Is." & demos$Ethnicity == "Not Hispanic/Latino"] <- "Asian"
demos$race_eth[demos$Race == "More than one" & demos$Ethnicity =="Not Hispanic/Latino" ] <- "Multi-racial"
demos$race_eth[demos$Race == "Unknown or Not Reported" & demos$Ethnicity =="Not Hispanic/Latino" ] <- "Unknown or not reported"

demos$race_eth[demos$Race == "White" & demos$Ethnicity =="Unknown or Not Reported"] <- "White"
demos$race_eth[demos$Race == "Black or African Am." & demos$Ethnicity =="Unknown or Not Reported"] <- "Black or African American"
demos$race_eth[demos$Race == "Am. Indian/Alaskan Nat." & demos$Ethnicity =="Unknown or Not Reported" ] <- "Native American"
demos$race_eth[demos$Race == "Asian/Nat. Hawaiian/Othr Pacific Is." & demos$Ethnicity =="Unknown or Not Reported"] <- "Asian"
demos$race_eth[demos$Race == "More than one" & demos$Ethnicity =="Unknown or Not Reported" ] <- "Multi-racial"
demos$race_eth[demos$Race == "Unknown or Not Reported" & demos$Ethnicity =="Unknown or Not Reported" ] <- "Unknown or not reported"

demos$race_eth <- ordered(demos$race_eth, levels = c("White", "Black or African American"  , "Asian" ,
                                             "Multi-racial" , "Unknown or not reported and Hispanic","Multi-racial and Hispanic",
                                             "Black or African American and Hispanic", "White and Hispanic"))


```
## Unresitricted data
```{r, echo=FALSE}
unres<-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/unrestricted_gshearrer_4_19_2018_11_31_37.csv", header=T, sep=",")
myvars<-c("Subject","Gender")
unres<-unres[myvars]
unres$sub<-unres$Subject
head(unres)
```

## Graph data
```{r, echo=FALSE}
graph_df<-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/submodule_data.csv", sep=",", header=T)
head(graph_df)
graph_df$group <- factor(graph_df$group, levels = c("normal","overweight","obese"))
```

## Individual data
```{r, echo=FALSE}
setwd("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp")

# Reading in all the data from python 
tbl <- 
  list.files(pattern = "*_per_sub.csv") %>% 
  map_df(~read_csv(.))

dim(tbl)

fc_tbl <- 
  list.files(pattern = "*FC.csv") %>% 
  map_df(~read_csv(.))

dim(fc_tbl)

tbl<-join(tbl,fc_tbl)
```
## Edge data
```{r}
edge_df = read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/sub_edge_data.csv", sep=",", header = T)
mod_edge_df = read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/sub_comm_edge_data.csv", sep=",", header = T)

```

# joining individual sub data 
```{r, echo=FALSE}
data<-join(tbl,demos)
dim(data)
# names(data)
data<-join(data, unres)
dim(data)
```
# Cleanup, center, ect
```{r, echo=FALSE}
cols <- c("sub","Gender" ,"ZygosityGT", "Ethnicity", "Mother_ID","Father_ID","group","race_eth", "measure")

data %<>% mutate_at(cols, funs(factor(.)))
str(data[100:114])

data$group <- ordered(data$group, levels = c("no", "ov", "ob"))

```
```{r, echo=FALSE}
levels(graph_df$area)
graph_df$area<-revalue(graph_df$area, c("cerebellum"="Cerebellum"))
graph_df$area<-revalue(graph_df$area, c("None"=""))

```

## Contrasts for demographics
```{r, echo=FALSE}
dat<-data[!duplicated(data[,c('sub')]),]
levels(dat$group)    
levels(dat$race_eth)

#          no  ov  ob
cons<- list(
  noVov = c(1, -1,  0),
  noVob = c(1,  0, -1),
  ovVob = c(0,  1, -1)
) 
```
# Covariates
## Age
```{r, echo=FALSE}
dm1<-lm(Age_c~group, data=dat)
summary(dm1)
lsq_dm1 = lsmeans(dm1, "group")
contrast(lsq_dm1, cons, adjust='fdr')

violin(dat,dat$group,dat$Age_c)
describeBy(dat$Age_in_Yrs, dat$group)
## No difference in age 
```

# BMI
```{r, echo=FALSE}
dm2<-lm(BMI~group, data=dat)
lsq_dm2 = lsmeans(dm2, "group")
contrast(lsq_dm2, cons, adjust='fdr')
## Sanity check difference between the groups
violin(dat,dat$group,dat$BMI)
describeBy(dat$BMI, dat$group)
```

#HBA1c
```{r, echo=FALSE}
dm3<-lm(HBA1c_c~group, data=dat)
summary(dm3)
lsq_dm3 = lsmeans(dm3, "group")
contrast(lsq_dm3, cons, adjust='fdr')

violin(dat,dat$group,dat$HbA1C)
describeBy(dat$HbA1C, dat$group)
```


## sex
```{r, echo=FALSE}
chisq.test(table(dat$group, dat$Gender))
tapply(dat$group, dat$Gender, summary)

balloonplot(table(dat$group, dat$Gender), main ="Gender Frequencies", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, colmar=5, dotcolor=cbPalette)
```
## Race
```{r, echo=FALSE}
chisq.test(table(dat$group, dat$race_eth))
tapply(dat$group, dat$race_eth, summary)

balloonplot(table(dat$group, dat$race_eth), main ="Racial/Ethnic Frequencies", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, dotcolor=cbPalette, colmar=5)
```

# Models
```{r}
fit_function<-function(y,data){
  fit<-lm(y~group+Age_c+HBA1c_c+Gender+race_eth+FC, data=data)
  test.emm <- emmeans(fit, "group")
  contest<-emmeans(test.emm, pairwise ~ group)
  test.emm.s <- update(contest$contrasts, infer = c(TRUE, TRUE))
  return(summary(test.emm.s))
}

dfer<-function(X,Y){
  df<-data.frame(X,Y, stringsAsFactors=FALSE)
  return(df)
}
```



## clustering
```{r}
cluster<-subset(data, data$measure == "cluster")

clus_vals<-apply(cluster[2:101], FUN=fit_function, MARGIN = 2 ,data=cluster)
indx<-names(clus_vals)

l <- list()
for (i in seq(1, length(clus_vals), by= 1)){
#  print(paste("start", i))
  df <- dfer(indx[i],clus_vals[i])
  colnames(df) <- c("IC", "contrast", "estimate","SE","df", "lower.CL", "upper.CL", "t.ratio", "p.value")
  l[[i]] <-df
}

df_cluster<-bind_rows(l)
df_cluster$pFDR<-p.adjust(df_cluster$p.value, method = "BH")
df_cluster[df_cluster$p.value <= 0.05, ] 

violin(cluster,cluster$group,cluster$IC_16)
violin(cluster,cluster$group,cluster$IC_23)
```

## centrality
```{r}
centrality<-subset(data, data$measure == "centrality")

cen_vals<-apply(centrality[2:101], FUN=fit_function, MARGIN = 2 ,data=centrality)
indx<-names(cen_vals)

l <- list()
for (i in seq(1, length(cen_vals), by= 1)){
#  print(paste("start", i))
  df <- dfer(indx[i],cen_vals[i])
  colnames(df) <- c("IC", "contrast", "estimate","SE","df", "lower.CL", "upper.CL", "t.ratio", "p.value")
  l[[i]] <-df
}

df_centrality<-bind_rows(l)
df_centrality$pFDR<-p.adjust(df_centrality$p.value, method = "BH")

df_centrality[df_centrality$p.value <= 0.05, ] 

violin(centrality,centrality$group,centrality$IC_16)
violin(centrality,centrality$group,centrality$IC_11)
```

## participation coeffiecent 
```{r}
PC<-subset(data, data$measure == "PC")

PC_vals<-apply(PC[2:101], FUN=fit_function, MARGIN = 2 ,data=PC)
indx<-names(PC_vals)

l <- list()
for (i in seq(1, length(PC_vals), by= 1)){
  # print(paste("start", i))
  df <- dfer(indx[i],PC_vals[i])
  colnames(df) <- c("IC", "contrast", "estimate","SE","df", "lower.CL", "upper.CL", "t.ratio", "p.value")
  l[[i]] <-df
}

df_PC<-bind_rows(l)
df_PC$pFDR<-p.adjust(df_PC$p.value, method = "BH")

df_PC[df_PC$p.value <= 0.05, ] 
```
## Nodal roles
```{r}
chisq.test(table(graph_df$group, graph_df$node_type))
tapply(graph_df$group, graph_df$node_type, summary)

balloonplot(table(graph_df$group, graph_df$node_type), main ="Node Frequencies", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 5, colmar=5, dotcolor=cbPalette)
```

```{r}
gmod_function<-function(group,num,data){
  y<-subset(data, data$group == sprintf("%s", group))
  x<-subset(y, y$modules == sprintf("%s", num))
  pX<-balloonplot(table(x$node_type, x$area), main =  sprintf("Module Frequencies by %s", num), xlab ="", ylab="",
              label = TRUE, show.margins = FALSE, colsrt = 90, text.size=1 ,dotsize = 5, colmar=5, dotcolor=cbPalette[2])
  my_list <- list(pX, chisq.test(table(x$group, x$area)))
  return(my_list)
}
pod_function<-function(num,data){
  x<-subset(data, data$modules == sprintf("%s", num))
  pX<-balloonplot(table(x$group, x$area), main =  sprintf("Module Frequencies by %s", num), xlab ="", ylab="",
              label = TRUE, show.margins = FALSE, colsrt = 90, text.size=1 ,dotsize = 5, colmar=5, dotcolor=cbPalette[2])
  my_list <- list(pX, chisq.test(table(x$group, x$area)))
  return(my_list)
}
```



```{r}

chisq.test(table(graph_df$group, graph_df$module))

table(graph_df$group, graph_df$module)
pAll<-balloonplot(table(graph_df$group, graph_df$module), main ="Module Frequencies by group", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90, text.size=1 ,dotsize = 5, colmar=5, dotcolor='grey')
# By Mod
```


```{r}
x = 1
no_<-subset(graph_df, graph_df$group == "normal")
balloonplot(table(no_$module, no_$area), main ="Module Frequencies per functional network average BMI", xlab ="", ylab="", label = TRUE, show.margins = FALSE, colsrt = 90, text.size=x ,dotsize = 5, colmar=5, dotcolor=cbPalette[1])

no_2<-subset(no_, no_$module == 2)
balloonplot(table(no_2$node_type, no_2$area), main ="Module Frequencies per functional network average BMI sensory", xlab ="", ylab="", label = TRUE, show.margins = FALSE, colsrt = 90, text.size=x ,dotsize = 5, colmar=5, dotcolor=cbPalette[1])

no_5<-subset(no_, no_$module == 5)
balloonplot(table(no_5$node_type, no_5$area), main ="Module Frequencies per functional network average BMI subcortical", xlab ="", ylab="", label = TRUE, show.margins = FALSE, colsrt = 90, text.size=x ,dotsize = 5, colmar=5, dotcolor=cbPalette[1])

ov_<-subset(graph_df, graph_df$group == "overweight")
balloonplot(table(ov_$module, ov_$area), main ="Module Frequencies per functional network high BMI", xlab ="", ylab="", label = TRUE, show.margins = FALSE, colsrt = 90, text.size=x ,dotsize = 5, colmar=5, dotcolor=cbPalette[2])

ov_2<-subset(ov_, ov_$module == 2)
balloonplot(table(ov_2$node_type, ov_2$area), main ="Module Frequencies per sensory high BMI", xlab ="", ylab="", label = TRUE, show.margins = FALSE, colsrt = 90, text.size=x ,dotsize = 5, colmar=5, dotcolor=cbPalette[2])

ov_6<-subset(ov_, ov_$module == 6)
balloonplot(table(ov_6$node_type, ov_6$area), main ="Module Frequencies per subcortical high BMI module 5", xlab ="", ylab="", label = TRUE, show.margins = FALSE, colsrt = 90, text.size=x ,dotsize = 5, colmar=5, dotcolor=cbPalette[2])


ob_<-subset(graph_df, graph_df$group == "obese")
balloonplot(table(ob_$module, ob_$area), main ="Module Frequencies per functional network very high BMI", xlab ="", ylab="", label = TRUE, show.margins = FALSE, colsrt = 90, text.size=x ,dotsize = 5, colmar=5, dotcolor=cbPalette[3])

ob_4<-subset(ob_, ob_$module == 4)
balloonplot(table(ob_4$node_type, ob_4$area), main ="Module Frequencies per sensory very high BMI", xlab ="", ylab="", label = TRUE, show.margins = FALSE, colsrt = 90, text.size=x ,dotsize = 5, colmar=5, dotcolor=cbPalette[3])

ob_6<-subset(ob_, ob_$module == 6)
balloonplot(table(ob_6$node_type, ob_6$area), main ="Module Frequencies per subcortical very high BMI module 6", xlab ="", ylab="", label = TRUE, show.margins = FALSE, colsrt = 90, text.size=x ,dotsize = 5, colmar=5, dotcolor=cbPalette[3])
```
```{r}
graph_df$module<-as.factor(graph_df$module)
```

```{r}
mod_function<-function(y,data){
  fit<-lm(y~group, data=data)
  test.emm <- emmeans(fit, "group")
  contest<-emmeans(test.emm, pairwise ~ group)
  test.emm.s <- update(contest$contrasts, infer = c(TRUE, TRUE))
  return(summary(test.emm.s))
}

mod_function(graph_df$centrality,graph_df)
mod_function(graph_df$clustering,graph_df)
mod_function(graph_df$PC,graph_df)

violin(graph_df, graph_df$group, graph_df$centrality)
violin(graph_df, graph_df$group, graph_df$clustering)
violin(graph_df, graph_df$group, graph_df$PC)
```

```{r}
warp <- transform(graph_df, mods = interaction(group, area))

PC.gls <- gls(PC ~ mods, data = warp)
PC.emm <- emmeans(PC.gls, "mods")
PC.fac <- update(PC.emm, levels = list(
                group = c("normal", "overweight", "obese"), 
                area = c("","Amygdala", "Auditory", "BrainStem", "Caudate", "Cerebellum", "CinguloOperc",
                         "Default", "DorsalAttn", "FrontoParietal", "MedialParietal", "Putamen",
                         "Smhand", "Smmouth", "Thalamus", "VentralAttn", "VentralDiencephalon", "Visual")))

contrast(PC.fac, "pairwise", by = "area", adjust = "fdr")

DMN_PC<-subset(warp, warp$area == "Default")
violin(DMN_PC, DMN_PC$group, DMN_PC$PC)

mouth_PPC<-subset(warp, warp$area == "Smmouth")
mouth_PPC

describeBy(mouth_PPC$PC,mouth_PPC$group)

hand_PPC<-subset(warp, warp$area == "Smhand")
violin(hand_PPC, hand_PPC$group, hand_PPC$PC)
```
```{r}
summary(graph_df$module)
gdf<-subset(graph_df, graph_df$module != 7)
gdf<-subset(gdf, gdf$module != 8)
gdf$module<-factor(gdf$module)
summary(gdf$module)
```

```{r}
table(gdf$group, gdf$module)
warp_tour <- transform(gdf, mods = interaction(group, module))
```


```{r}
mPC.gls <- gls(PC ~ mods, data = warp_tour)
mPC.emm <- emmeans(mPC.gls, "mods")
mPC.fac <- update(mPC.emm, levels = list(
                group = c("normal", "overweight", "obese"), 
                area = c("0","1","2","3","4","5","6")))

mPC.emm@model.info[["xlev"]][["mods"]]

contrast(mPC.fac, "pairwise", by = "area", adjust = "fdr")

PC_2<-subset(warp, warp$module == "2")
violin(PC_2, PC_2$group, PC_2$PC)

PC_0<-subset(warp, warp$module == "0")
violin(PC_0, PC_0$group, PC_0$PC)
```
## Testing edges 
```{r}
mod_edge_df$source<-as.factor(mod_edge_df$source)
mod_edge_df$target<-as.factor(mod_edge_df$target)


edf<-subset(mod_edge_df, mod_edge_df$source != 7)
edf<-subset(edf, edf$source != 8)
edf<-subset(edf, edf$target != 7)
edf<-subset(edf, edf$target != 8)

edf$source<-factor(edf$source)
edf$target<-factor(edf$target)

summary(edf$source)
summary(edf$target)
```
```{r}
warp_edges <- transform(edf, mods = interaction(group, source, target))
head(warp_edges)
# no.2.5 vs. ov.2.6 vs. ob.4.6
warp_edges$newvar <- NA
warp_edges[warp_edges$mods == 'no.2.5', "newvar"] <- 'aBMI'
warp_edges[warp_edges$mods == 'ov.2.6', "newvar"] <- 'hBMI'
warp_edges[warp_edges$mods == 'ob.4.6', "newvar"] <- 'vhBMI'

summary(as.factor(warp_edges$newvar))
head(warp_edges)
warp_edges$newvar<-as.factor(warp_edges$newvar)
levels(warp_edges$newvar)
warp_spec<-warp_edges[complete.cases(warp_edges), ]
head(warp_spec)
warp_spec$mods<-factor(warp_spec$mods)
levels(warp_spec$mods)
```
```{r}
warp_spec <- transform(warp_spec, mods = interaction(group, source, target))
warp_spec$mods<-factor(warp_spec$mods)
levels(warp_spec$mods)
head(warp_spec)
zW1.gls <- gls(z_weight ~ newvar, data = warp_spec)
zW1.gls
zW1.emm <- emmeans(zW1.gls, "newvar")

contrast(zW1.emm, "pairwise",  adjust = "fdr")

violin(warp_spec, warp_spec$newvar, warp_spec$z_weight)
```
```


```{r}
head(edf)
warp_edges <- transform(edf, mods = interaction(group, source, target))
head(warp_edges)
levels(warp_edges$mods)
zW.gls <- gls(z_weight ~ mods, data = warp_edges)
zW.emm <- emmeans(zW.gls, "mods")
zW.emm@grid
zW.fac <- update(zW.emm, levels = list(
                group = c("no", "ov", "ob"), 
                edge = c("0.1","0.2","0.3","0.4", "0.5", "0.6", 
                         "1.2","1.3","1.4","1.5","1.6",
                         "2.3","2.4","2.5","2.6",
                         "3.4","3.5","3.6",
                         "4.5","4.6",
                         "5.6")))
total <- contrast(zW.fac, "pairwise", by = "area", adjust = "fdr")
total
```
## `xtable` with HTML
```{r, echo=FALSE, message=FALSE, results='asis'}
library(viridisLite)
## `knitr::kable` 
knitr::kable(total, format = "html", digits = 2, align = c('l','l','c','c','c','c','c'), col.names = c("Contrast","Edge connection","Estimate","Standard error", "df", "t-ratio", "pFDR"))%>%
  kable_styling(full_width = FALSE, position = "left")
```  

``` 




Nice function to make a pretty table
```{r}
library(mosaic)
tablr<-function(Y,x,D){
  Q<-favstats(Y ~ x, data = D)
  Q.stat <- Q[, c("x", "n", "mean", "sd")]
  colnames(Q.stat)<-c("test","n", "mean", "sd")
  a<-match.call()[2]
  return(Q.stat)
}

quickr<-function(X, Y, Z, X2, Y2, Z2, X3){
  a<-merge(X, Y, by="test")
  b<-merge(a, Z, by="test")

  c<-merge(X2, Y2,by="test")
  d<-merge(c, Z2, by="test")
  # e<-merge(d, X3, by="test")
  d$test<-revalue(d$test, c( "no" = "Total",
                             "ov" = "Total",
                             "ob" = "Total",
                             "1" = "Total"))


  e<-rbind(b,d)
  f<-merge(e,X3, by="test")
  drops <- c("Y")
  f<-f[ , !(names(f) %in% drops)]
  # f<-rbind(e,X3)
  
  library("plyr")
  f$test<-revalue(f$test, c("Am. Indian/Alaskan Nat."=  "Native American",            
                                  "Asian/Nat. Hawaiian/Othr Pacific Is."=  "Asian, Native Hawaiian, or Pacific Islander",
                                  "Black or African Am."= "Black or African American",
                                  "More than one"= "More than one race",                      
                                  "Unknown or Not Reported"= "Unknown or chose not to report",
                                  "White"= "White",
                                  "Total"="Total"))
  f$test <- factor(f$test, levels = c( "Native American",            
                                  "Asian, Native Hawaiian, or Pacific Islander",
                                  "Black or African American",
                                  "More than one race",                      
                                  "Unknown or chose not to report",
                                  "White",
                                  "Total"))

  return(f)
}

sexr<-function(X,Y){
  a <- table(X,Y)
  b <- prop.table(a,margin=2)
  c<-round(b*100, 1)
  d<-data.frame(c)
  e<-subset(d, d$Y == "F")
  e<-rename(e, c("X"="test"))
  A<-table(Y)
  B <- prop.table(A)
  C<-round(B*100, 1)
  D<-data.frame(C)
  E<-subset(D, D$Y == "F")
  test <- rep("Total",length(1))
  G <- cbind(test, E)
  f<-rbind(e,G)
  # return(rename(f, c("X"="test")))
  return(f)

}
```
"Native American", "Asian, Native Hawaiian, or Pacific Islander","Black or African American","More than one race","Unknown or chose not to report","White","Total"
X Y Freq
```{r}
demo_vars<-c("Race","BMI","HbA1C","Age_in_Yrs","group", "Gender")
dems<-dat[demo_vars]

groupSex<-table(dems$group, dems$Gender)
groupSex <- prop.table(groupSex,margin=2)
round(groupSex*100, 1)

#dems<-na.omit(dems)
dem_no<-subset(dems, dems$group == "no")
dem_no$group<-factor(dem_no$group)

dem_ov<-subset(dems, dems$group == "ov")
dem_ov$group<-factor(dem_ov$group)


dem_ob<-subset(dems, dems$group == "ob")
dem_ob$group<-factor(dem_ob$group)

```

# Making a nice table
```{r, echo=FALSE, warning=FALSE, message=FALSE}
NObyRace<-apply(dem_no, MARGIN = 2, FUN = tablr, x=dem_no$Race, D=dem_no)
NObyGroup<-apply(dem_no, MARGIN = 2, FUN = tablr, x=dem_no$group, D=dem_no)
NObySEX<-sexr(dem_no$Race,dem_no$Gender)

OVbyRace<-apply(dem_ov, MARGIN = 2, FUN = tablr, x=dem_ov$Race, D=dem_ov)
OVbyGroup<-apply(dem_ov, MARGIN = 2, FUN = tablr, x=dem_ov$group, D=dem_ov)
OVbySEX<-sexr(dem_ov$Race,dem_ov$Gender)


OBbyRace<-apply(dem_ob, MARGIN = 2, FUN = tablr, x=dem_ob$Race, D=dem_ob)
OBbyGroup<-apply(dem_ob, MARGIN = 2, FUN = tablr, x=dem_ob$group, D=dem_ob)
OBbySEX<-sexr(dem_ob$Race,dem_ob$Gender)

AllbyRace<-apply(dems, MARGIN = 2, FUN = tablr, x=dems$Race, D=dems)
AllbyGroup<-apply(dems, MARGIN = 2, FUN = tablr, x=1, D=dems)
AllbyGroup
AllbySEX<-sexr(dems$Race,dems$Gender)

AllbyGroup$BMI
AllbyGroup$HbA1C
AllbyGroup$Age_in_Yrs
```

```{r, echo=FALSE}
NO<-quickr(NObyRace$BMI, NObyRace$HbA1C, NObyRace$Age_in_Yrs, NObyGroup$BMI, NObyGroup$HbA1C, NObyGroup$Age_in_Yrs, NObySEX)
NO<-NO[order(NO$test),]

OV<-quickr(OVbyRace$BMI, OVbyRace$HbA1C, OVbyRace$Age_in_Yrs, OVbyGroup$BMI, OVbyGroup$HbA1C, OVbyGroup$Age_in_Yrs,OVbySEX)
OV<-OV[order(OV$test),]

OB<-quickr(OBbyRace$BMI, OBbyRace$HbA1C, OBbyRace$Age_in_Yrs, OBbyGroup$BMI, OBbyGroup$HbA1C, OBbyGroup$Age_in_Yrs, OBbySEX)
OB<-OB[order(OB$test),]

ALL<-quickr(AllbyRace$BMI, AllbyRace$HbA1C, AllbyRace$Age_in_Yrs, AllbyGroup$BMI, AllbyGroup$HbA1C, AllbyGroup$Age_in_Yrs, AllbySEX)
ALL
ALL<-ALL[order(ALL$test),]
ALL
```

```{r, echo=FALSE}

all<-rbind(NO, OV, OB, ALL)
all$test<-factor(all$test, levels = c( "Native American",            
                                  "Asian, Native Hawaiian, or Pacific Islander",
                                  "Black or African American",
                                  "More than one race",                      
                                  "Unknown or chose not to report",
                                  "White",
                                  "Total"))
all <- tibble::rownames_to_column(all, "VALUE")

all
drops <- c("VALUE")
all<-all[ , !(names(all) %in% drops)]
```

```{r}
colz<-c("Race/Ethncity",
        "n","mean","SD",
        "n","mean","SD",
        "n","mean","SD",
        "%")
digz<-c(0, 2, 2, 0, 2, 2,0, 2, 2)
```


# Make the nice table
```{r nice table, echo=FALSE}
library(knitr)
library(kableExtra)
# library(magick)
# library(phantomjs)
#webshot::install_phantomjs()

kable(all, format = "html",  col.names = colz,
      caption = "Table 1: Descriptive statistics by reported race and BMI group",
      digits = digz, align = "lccc") %>%
  kable_styling(full_width = FALSE, position = "left") %>%
  add_header_above(c(" " = 1,"BMI"= 3,"HbA1C"= 3,"Age at scan"=3, "Female"=1)) %>%
  pack_rows("Average BMI", 1,7) %>%
  pack_rows("High BMI", 8, 14) %>%
  pack_rows("Very high BMI",15, 21)%>%
  pack_rows("Total Sample",22, 28)%>%
  save_kable("test2.pdf")
```
