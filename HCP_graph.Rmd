---
title: "HCP BMI"
output: html_notebook
---

# Libraries
```{r}
library(tidyverse)
library(magrittr)
library(purrr)
library(plyr)
library(ggplot2)
library(data.table)
library(dplyr)
# library(formattable)
library(gplots)
library(lm.beta)
library(mgcv)
library(lsmeans)
library(psych)
library(multcomp)
library(gridExtra)
library(grid)
library(nlme)
```


# Functions
```{r}
cbPalette <- c( "#E69F00", "#56B4E9",  "#CC79A7")
violin <- function(d, x, y){
  plot1<-ggplot(d, aes(factor(x), y)) + 
    geom_violin(aes(fill = x),stat = "ydensity",draw_quantiles = c(0.25, 0.5, 0.75))+scale_fill_manual(values=cbPalette)+theme_classic()
  return(plot1)
}
```

# Demographics
```{r}
demos<-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/demos.csv", header=T, sep=",")
head(demos)
demos$Age_c<-scale(demos$Age_in_Yrs, scale = FALSE)
demos$HBA1c_c<-scale(demos$HbA1C, scale = FALSE)
demos$group <- ordered(demos$group, levels = c("no", "ov", "ob"))

demos$race_eth[demos$Race == "White" & demos$Ethnicity == "Hispanic/Latino" ] <- "White and Hispanic"
demos$race_eth[demos$Race == "Black or African Am." & demos$Ethnicity =="Hispanic/Latino" ] <- "Black or African American and Hispanic"
demos$race_eth[demos$Race == "Am. Indian/Alaskan Nat." & demos$Ethnicity =="Hispanic/Latino" ] <- "Native American and Hispanic"
demos$race_eth[demos$Race == "Asian/Nat. Hawaiian/Othr Pacific Is." & demos$Ethnicity =="Hispanic/Latino" ] <- "Asian and Hispanic"
demos$race_eth[demos$Race == "More than one" & demos$Ethnicity =="Hispanic/Latino" ] <- "Multi-racial and Hispanic"
demos$race_eth[demos$Race == "Unknown or Not Reported" & demos$Ethnicity =="Hispanic/Latino" ] <- "Unknown or not reported and Hispanic"

demos$race_eth[demos$Race == "White" &demos$Ethnicity == "Not Hispanic/Latino"] <- "White"
demos$race_eth[demos$Race == "Black or African Am." & demos$Ethnicity =="Not Hispanic/Latino" ] <- "Black or African American"
demos$race_eth[demos$Race == "Am. Indian/Alaskan Nat." & demos$Ethnicity =="Not Hispanic/Latino" ] <- "Native American"
demos$race_eth[demos$Race == "Asian/Nat. Hawaiian/Othr Pacific Is." & demos$Ethnicity == "Not Hispanic/Latino"] <- "Asian"
demos$race_eth[demos$Race == "More than one" & demos$Ethnicity =="Not Hispanic/Latino" ] <- "Multi-racial"
demos$race_eth[demos$Race == "Unknown or Not Reported" & demos$Ethnicity =="Not Hispanic/Latino" ] <- "Unknown or not reported"

demos$race_eth[demos$Race == "White" & demos$Ethnicity =="Unknown or Not Reported"] <- "White"
demos$race_eth[demos$Race == "Black or African Am." & demos$Ethnicity =="Unknown or Not Reported"] <- "Black or African American"
demos$race_eth[demos$Race == "Am. Indian/Alaskan Nat." & demos$Ethnicity =="Unknown or Not Reported" ] <- "Native American"
demos$race_eth[demos$Race == "Asian/Nat. Hawaiian/Othr Pacific Is." & demos$Ethnicity =="Unknown or Not Reported"] <- "Asian"
demos$race_eth[demos$Race == "More than one" & demos$Ethnicity =="Unknown or Not Reported" ] <- "Multi-racial"
demos$race_eth[demos$Race == "Unknown or Not Reported" & demos$Ethnicity =="Unknown or Not Reported" ] <- "Unknown or not reported"

demos$race_eth <- ordered(demos$race_eth, levels = c("White", "Black or African American"  , "Asian" ,
                                             "Multi-racial" , "Unknown or not reported and Hispanic","Multi-racial and Hispanic",
                                             "Black or African American and Hispanic", "White and Hispanic"))


```
# Unresitricted data
```{r}
unres<-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/unrestricted_gshearrer_4_19_2018_11_31_37.csv", header=T, sep=",")
myvars<-c("Subject","Gender")
unres<-unres[myvars]
unres$sub<-unres$Subject
head(unres)
```

# Graph data
```{r}
graph_df<-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/submodule_data_handedit.csv", sep=",", header=T)
head(graph_df)
graph_df$group <- factor(graph_df$group, levels = c("normal","overweight","obese"))
```

# Individual data
```{r}
setwd("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp")

# Reading in all the data from python 
tbl <- 
  list.files(pattern = "*_per_sub.csv") %>% 
  map_df(~read_csv(.))

dim(tbl)

fc_tbl <- 
  list.files(pattern = "*FC.csv") %>% 
  map_df(~read_csv(.))

dim(fc_tbl)

tbl<-join(tbl,fc_tbl)
```
# joining individual sub data 
```{r}
data<-join(tbl,demos)
dim(data)
# names(data)
data<-join(data, unres)
dim(data)
```
# Cleanup, center, ect
```{r}
cols <- c("sub","Gender" ,"ZygosityGT", "Ethnicity", "Mother_ID","Father_ID","group","race_eth", "measure")

data %<>% mutate_at(cols, funs(factor(.)))
str(data[100:114])

data$group <- ordered(data$group, levels = c("no", "ov", "ob"))

```
## Contrasts for demographics
```{r}
dat<-data[!duplicated(data[,c('sub')]),]
levels(dat$group)    
levels(dat$race_eth)

#          no  ov  ob
cons<- list(
  noVov = c(1, -1,  0),
  noVob = c(1,  0, -1),
  ovVob = c(0,  1, -1)
) 
```
# Covariates
## Age
```{r}
dm1<-lm(Age_c~group, data=dat)
lsq_dm1 = lsmeans(dm1, "group")
contrast(lsq_dm1, cons, adjust='sidak')

violin(dat,dat$group,dat$Age_c)
describeBy(dat$Age_in_Yrs, dat$group)
## No difference in age 
```

#BMI
```{r}
dm2<-lm(BMI~group, data=dat)
lsq_dm2 = lsmeans(dm2, "group")
contrast(lsq_dm2, cons, adjust='sidak')
## Sanity check difference between the groups
violin(dat,dat$group,dat$BMI)
describeBy(dat$BMI, dat$group)
```

#HBA1c
```{r}
dm3<-lm(HBA1c_c~group, data=dat)
lsq_dm3 = lsmeans(dm3, "group")
contrast(lsq_dm3, cons, adjust='sidak')

violin(dat,dat$group,dat$HbA1C)
describeBy(dat$HbA1C, dat$group)
```





## sex
```{r}
chisq.test(table(dat$group, dat$Gender))
tapply(dat$group, dat$Gender, summary)

balloonplot(table(dat$group, dat$Gender), main ="Gender Frequencies", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, colmar=5, dotcolor=cbPalette)
```

## Race
```{r}
chisq.test(table(dat$group, dat$race_eth))
tapply(dat$group, dat$race_eth, summary)

balloonplot(table(dat$group, dat$race_eth), main ="Racial/Ethnic Frequencies", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, dotcolor=cbPalette, colmar=5)
```

# Models
```{r}
fit_function<-function(y,data){
  fit<-lm(y~group+Age_c+HBA1c_c+Gender+race_eth+FC, data=data)
  test.emm <- emmeans(fit, "group")
  contest<-emmeans(test.emm, pairwise ~ group)
  test.emm.s <- update(contest$contrasts, infer = c(TRUE, TRUE))
  return(summary(test.emm.s))
}

dfer<-function(X,Y){
  df<-data.frame(X,Y, stringsAsFactors=FALSE)
  return(df)
}

```

## clustering
```{r}
cluster<-subset(data, data$measure == "cluster")

clus_vals<-apply(cluster[2:101], FUN=fit_function, MARGIN = 2 ,data=cluster)
indx<-names(clus_vals)

l <- list()
for (i in seq(1, length(clus_vals), by= 1)){
  print(paste("start", i))
  df <- dfer(indx[i],clus_vals[i])
  colnames(df) <- c("IC", "contrast", "estimate","SE","df", "lower.CL", "upper.CL", "t.ratio", "p.value")
  l[[i]] <-df
}

df_cluster<-bind_rows(l)
df_cluster$pFDR<-p.adjust(df_cluster$p.value, method = "BH")

df_cluster[df_cluster$p.value <= 0.05, ] 

violin(cluster,cluster$group,cluster$IC_16)
violin(cluster,cluster$group,cluster$IC_23)
```

## centrality
```{r}
centrality<-subset(data, data$measure == "centrality")

cen_vals<-apply(centrality[2:101], FUN=fit_function, MARGIN = 2 ,data=centrality)
indx<-names(cen_vals)

l <- list()
for (i in seq(1, length(cen_vals), by= 1)){
  print(paste("start", i))
  df <- dfer(indx[i],cen_vals[i])
  colnames(df) <- c("IC", "contrast", "estimate","SE","df", "lower.CL", "upper.CL", "t.ratio", "p.value")
  l[[i]] <-df
}

df_centrality<-bind_rows(l)
df_centrality$pFDR<-p.adjust(df_centrality$p.value, method = "BH")

df_centrality[df_centrality$p.value <= 0.05, ] 

violin(centrality,centrality$group,centrality$IC_16)
violin(centrality,centrality$group,centrality$IC_11)
```



## participation coeffiecent 
```{r}
PC<-subset(data, data$measure == "PC")

PC_vals<-apply(PC[2:101], FUN=fit_function, MARGIN = 2 ,data=PC)
indx<-names(PC_vals)

l <- list()
for (i in seq(1, length(PC_vals), by= 1)){
  # print(paste("start", i))
  df <- dfer(indx[i],PC_vals[i])
  colnames(df) <- c("IC", "contrast", "estimate","SE","df", "lower.CL", "upper.CL", "t.ratio", "p.value")
  l[[i]] <-df
}

df_PC<-bind_rows(l)
df_PC$pFDR<-p.adjust(df_PC$p.value, method = "BH")

df_PC[df_PC$p.value <= 0.05, ] 
```

```{r}
chisq.test(table(graph_df$group, graph_df$node_type))
tapply(graph_df$group, graph_df$node_type, summary)

balloonplot(table(graph_df$group, graph_df$node_type), main ="Node Frequencies", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 5, colmar=5, dotcolor=cbPalette)

```
```{r}
chisq.test(table(graph_df$group, graph_df$sub_module))
balloonplot(table(graph_df$group, graph_df$sub_module), main ="Sub_module Frequencies", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90, text.size=1 ,dotsize = 5, colmar=5, dotcolor=cbPalette)

```

```{r}
chisq.test(table(graph_df$modules, graph_df$sub_module))
balloonplot(table(graph_df$modules, graph_df$sub_module), main ="Sub_module Frequencies in modules", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90, text.size=1 ,dotsize = 5, colmar=5, dotcolor=cbPalette)

```

```{r}
graph_df$modules<-as.factor(graph_df$modules)
```

```{r}
head(graph_df)

mod_function<-function(y,data){
  fit<-lm(y~group, data=data)
  test.emm <- emmeans(fit, "group")
  contest<-emmeans(test.emm, pairwise ~ group)
  test.emm.s <- update(contest$contrasts, infer = c(TRUE, TRUE))
  return(summary(test.emm.s))
}

mod_function(graph_df$centrality,graph_df)
mod_function(graph_df$clustering,graph_df)
mod_function(graph_df$PC,graph_df)
mod_function(abs(graph_df$zDegree),graph_df)

violin(graph_df, graph_df$group, abs(graph_df$zDegree))
violin(graph_df, graph_df$group, graph_df$centrality)
violin(graph_df, graph_df$group, graph_df$clustering)
violin(graph_df, graph_df$group, graph_df$PC)

```






```{r}
levels(graph_df$area)
graph_df$modules<-as.factor(graph_df$modules)
warp <- transform(graph_df, mods = interaction(group, area))

warp$mods
head(warp)
```

```{r}
zD.gls <- gls(zDegree ~ mods, data = warp)
zD.emm <- emmeans(zD.gls, "mods")
zD.fac <- update(zD.emm, levels = list(
                group = c("normal", "overweight", "obese"), 
                area = c("","Amygdala","Auditory","BrainStem", "Caudate", "Cerebellum", "CinguloOperc","Default",
                            "DorsalAttn","FrontoParietal","MedialParietal","None","Putamen","Smhand","Smmouth","Thalamus",
                            "VentralAttn","VentralDiencephalon", "Visual" )))

contrast(zD.fac, "pairwise", by = "area", adjust = "fdr")
cer_z<-subset(warp, warp$area == "Cerebellum")
violin(cer_z,cer_z$group,cer_z$zDegree)

VD_z<-subset(warp, warp$area == "VentralDiencephalon")
describeBy(VD_z$zDegree, VD_z$group)
```
Cerebellum
Ventral Diencephalon

```{r}
PC.gls <- gls(PC ~ mods, data = warp)
PC.emm <- emmeans(PC.gls, "mods")
PC.fac <- update(PC.emm, levels = list(
                group = c("normal", "overweight", "obese"), 
                area = c("","Amygdala","Auditory","BrainStem", "Caudate", "Cerebellum", "CinguloOperc","Default",
                            "DorsalAttn","FrontoParietal","MedialParietal","None","Putamen","Smhand","Smmouth","Thalamus",
                            "VentralAttn","VentralDiencephalon", "Visual" )))

contrast(PC.fac, "pairwise", by = "area", adjust = "fdr")

DMN_PC<-subset(warp, warp$area == "Default")
violin(DMN_PC, DMN_PC$group, DMN_PC$PC)

FP_PPC<-subset(warp, warp$area == "FrontoParietal")
violin(FP_PPC, FP_PPC$group, FP_PPC$PC)

vis_PPC<-subset(warp, warp$area == "Visual")
violin(vis_PPC, vis_PPC$group, vis_PPC$PC)
```

```{r}
# head(warp)
clus.gls <- gls(clustering ~ mods, data = warp)
clus.emm <- emmeans(clus.gls, "mods")
clus.fac <- update(clus.emm, levels = list(
                group = c("normal", "overweight", "obese"), 
                area = c("","Amygdala","Auditory","BrainStem", "Caudate", "Cerebellum", "CinguloOperc","Default",
                            "DorsalAttn","FrontoParietal","MedialParietal","None","Putamen","Smhand","Smmouth","Thalamus",
                            "VentralAttn","VentralDiencephalon", "Visual" )))

contrast(clus.fac, "pairwise", by = "area", adjust = "fdr")
```

```{r}
cent.gls <- gls(centrality ~ mods, data = warp)
cent.emm <- emmeans(cent.gls, "mods")
cent.fac <- update(cent.emm, levels = list(
                group = c("normal", "overweight", "obese"), 
                area = c("","Amygdala","Auditory","BrainStem", "Caudate", "Cerebellum", "CinguloOperc","Default",
                            "DorsalAttn","FrontoParietal","MedialParietal","None","Putamen","Smhand","Smmouth","Thalamus",
                            "VentralAttn","VentralDiencephalon", "Visual" )))

contrast(cent.fac, "pairwise", by = "area", adjust = "fdr")
```





Nice function to make a pretty table
```{r}
library(mosaic)
tablr<-function(Y,x,D){
  Q<-favstats(Y ~ x, data = D)
  Q.stat <- Q[, c("x", "n", "mean", "sd")]
  colnames(Q.stat)<-c("test","n", "mean", "sd")
  a<-match.call()[2]
  return(Q.stat)
}

quickr<-function(X, Y, Z, X2, Y2, Z2, X3){
  a<-merge(X, Y, by="test")
  b<-merge(a, Z, by="test")

  c<-merge(X2, Y2,by="test")
  d<-merge(c, Z2, by="test")
  # e<-merge(d, X3, by="test")
  d$test<-revalue(d$test, c( "no" = "Total",
                             "ov" = "Total",
                             "ob" = "Total"))


  e<-rbind(b,d)
  f<-merge(e,X3, by="test")
  drops <- c("Y")
  f<-f[ , !(names(f) %in% drops)]
  # f<-rbind(e,X3)
  
  library("plyr")
  f$test<-revalue(f$test, c("Am. Indian/Alaskan Nat."=  "Native American",            
                                  "Asian/Nat. Hawaiian/Othr Pacific Is."=  "Asian, Native Hawaiian, or Pacific Islander",
                                  "Black or African Am."= "Black or African American",
                                  "More than one"= "More than one race",                      
                                  "Unknown or Not Reported"= "Unknown or chose not to report",
                                  "White"= "White",
                                  "Total"="Total"))
    f$test <- factor(f$test, levels = c( "Native American",            
                                  "Asian, Native Hawaiian, or Pacific Islander",
                                  "Black or African American",
                                  "More than one race",                      
                                  "Unknown or chose not to report",
                                  "White",
                                  "Total"))

  return(f)
}

sexr<-function(X,Y){
  a <- table(X,Y)
  b <- prop.table(a,margin=2)
  c<-round(b*100, 1)
  d<-data.frame(c)
  e<-subset(d, d$Y == "F")
  e<-rename(e, c("X"="test"))
  A<-table(Y)
  B <- prop.table(A)
  C<-round(B*100, 1)
  D<-data.frame(C)
  E<-subset(D, D$Y == "F")
  test <- rep("Total",length(1))
  G <- cbind(test, E)
  f<-rbind(e,G)
  # return(rename(f, c("X"="test")))
  return(f)

}
sexr(dem_no$Race, dem_no$Gender)
```
"Native American", "Asian, Native Hawaiian, or Pacific Islander","Black or African American","More than one race","Unknown or chose not to report","White","Total"
X Y Freq
```{r}
demo_vars<-c("Race","BMI","HbA1C","Age_in_Yrs","group", "Gender")
dems<-dat[demo_vars]

groupSex<-table(dems$group, dems$Gender)
groupSex <- prop.table(groupSex,margin=2)
round(groupSex*100, 1)

#dems<-na.omit(dems)
dem_no<-subset(dems, dems$group == "no")
dem_no$group<-factor(dem_no$group)

dem_ov<-subset(dems, dems$group == "ov")
dem_ov$group<-factor(dem_ov$group)


dem_ob<-subset(dems, dems$group == "ob")
dem_ob$group<-factor(dem_ob$group)
```

# Making a nice table
```{r, warning=FALSE, message=FALSE}


NObyRace<-apply(dem_no, MARGIN = 2, FUN = tablr, x=dem_no$Race, D=dem_no)
NObyGroup<-apply(dem_no, MARGIN = 2, FUN = tablr, x=dem_no$group, D=dems)
NObySEX<-sexr(dem_no$Race,dem_no$Gender)

OVbyRace<-apply(dem_ov, MARGIN = 2, FUN = tablr, x=dem_ov$Race, D=dem_ov)
OVbyGroup<-apply(dem_ov, MARGIN = 2, FUN = tablr, x=dem_ov$group, D=dem_ov)
OVbySEX<-sexr(dem_ov$Race,dem_ov$Gender)


OBbyRace<-apply(dem_ob, MARGIN = 2, FUN = tablr, x=dem_ob$Race, D=dem_ob)
OBbyGroup<-apply(dem_ob, MARGIN = 2, FUN = tablr, x=dem_ob$group, D=dem_ob)
OBbySEX<-sexr(dem_ob$Race,dem_ob$Gender)
```

```{r}
NO<-quickr(NObyRace$BMI, NObyRace$HbA1C, NObyRace$Age_in_Yrs, NObyGroup$BMI, NObyGroup$HbA1C, NObyGroup$Age_in_Yrs, NObySEX)
NO<-NO[order(NO$test),]

OV<-quickr(OVbyRace$BMI, OVbyRace$HbA1C, OVbyRace$Age_in_Yrs, OVbyGroup$BMI, OVbyGroup$HbA1C, OVbyGroup$Age_in_Yrs,OVbySEX)
OV<-OV[order(OV$test),]

OB<-quickr(OBbyRace$BMI, OBbyRace$HbA1C, OBbyRace$Age_in_Yrs, OBbyGroup$BMI, OBbyGroup$HbA1C, OBbyGroup$Age_in_Yrs, OBbySEX)
OB<-OV[order(OB$test),]
```

```{r}

all<-rbind(NO, OV, OB)
all$test<-factor(all$test, levels = c( "Native American",            
                                  "Asian, Native Hawaiian, or Pacific Islander",
                                  "Black or African American",
                                  "More than one race",                      
                                  "Unknown or chose not to report",
                                  "White",
                                  "Total"))
all <- tibble::rownames_to_column(all, "VALUE")

all
drops <- c("VALUE")
all<-all[ , !(names(all) %in% drops)]

all

# all<-all[ , !(names(all) %in% drops)]
# all
```
```{r}
dim(all)
colz<-c("Race/Ethncity",
        "n","mean","SD",
        "n","mean","SD",
        "n","mean","SD",
        "%")
length(colz)
digz<-c(0, 2, 2, 0, 2, 2,0, 2, 2)
length(digz)
```


# Make the nice table
```{r nice table}
library(knitr)
library(kableExtra)

kable(all, format = "html",  col.names = colz,
      caption = "Table 1: Descriptive statistics by reported race and BMI group",
      digits = digz, align = "lccc") %>%
  kable_styling(full_width = FALSE, position = "left") %>%
  add_header_above(c(" " = 1,"BMI"= 3,"HbA1C"= 3,"Age at scan"=3, "Female"=1)) %>%
  pack_rows("Average BMI", 1,7) %>%
  pack_rows("High BMI", 8,14) %>%
  pack_rows("Very high BMI", 15,21)

```
