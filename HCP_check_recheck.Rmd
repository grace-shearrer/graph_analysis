---
title: "HCP_check"
author: "GShearrer"
date: "9/17/2020"
output: 
  html_document: 
    fig_width: 8
---

This document is to double check the results from the HCP_graph document
```{r, echo=FALSE}
library(tidyverse)
library(magrittr)
library(purrr)
library(plyr)
library(ggplot2)
library(data.table)
library(dplyr)
# library(formattable)
library(gplots)
library(lm.beta)
library(mgcv)
library(lsmeans)
library(psych)
library(multcomp)
library(gridExtra)
library(grid)
library(nlme)
library(ggpubr)
library(splines)
library(ggformula)
library(lmtest)
```

# Functions
```{r, echo=FALSE}
cbPalette <- c( "#E69F00", "#56B4E9",  "#CC79A7")
violin <- function(d, x, y){
  plot1<-ggplot(d, aes(factor(x), y)) + 
    geom_violin(aes(fill = x),stat = "ydensity",draw_quantiles = c(0.25, 0.5, 0.75))+scale_fill_manual(values=cbPalette)+theme_classic()
  return(plot1)
}
```


```{r}
dat_check <-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/complete_data.csv", sep=",", header=T)
head(dat_check)
dat_check$Subject <- as.factor(dat_check$Subject)
colnames(dat_check)
```


#  Loading in the data
## Demographics
```{r, echo=FALSE}
dat_check$Age_c<-scale(dat_check$Age_in_Yrs, scale = FALSE)
dat_check$HBA1c_c<-scale(dat_check$HbA1C, scale = FALSE)
dat_check$group <- ordered(dat_check$group, levels = c("no", "ov", "ob"))

dat_check$race_eth[dat_check$Race == "White" & dat_check$Ethnicity == "Hispanic/Latino" ] <- "White and Hispanic"
dat_check$race_eth[dat_check$Race == "Black or African Am." & dat_check$Ethnicity =="Hispanic/Latino" ] <- "Black or African American and Hispanic"
dat_check$race_eth[dat_check$Race == "Am. Indian/Alaskan Nat." & dat_check$Ethnicity =="Hispanic/Latino" ] <- "Native American and Hispanic"
dat_check$race_eth[dat_check$Race == "Asian/Nat. Hawaiian/Othr Pacific Is." & dat_check$Ethnicity =="Hispanic/Latino" ] <- "Asian and Hispanic"
dat_check$race_eth[dat_check$Race == "More than one" & dat_check$Ethnicity =="Hispanic/Latino" ] <- "Multi-racial and Hispanic"
dat_check$race_eth[dat_check$Race == "Unknown or Not Reported" & dat_check$Ethnicity =="Hispanic/Latino" ] <- "Unknown or not reported and Hispanic"

dat_check$race_eth[dat_check$Race == "White" &dat_check$Ethnicity == "Not Hispanic/Latino"] <- "White"
dat_check$race_eth[dat_check$Race == "Black or African Am." & dat_check$Ethnicity =="Not Hispanic/Latino" ] <- "Black or African American"
dat_check$race_eth[dat_check$Race == "Am. Indian/Alaskan Nat." & dat_check$Ethnicity =="Not Hispanic/Latino" ] <- "Native American"
dat_check$race_eth[dat_check$Race == "Asian/Nat. Hawaiian/Othr Pacific Is." & dat_check$Ethnicity == "Not Hispanic/Latino"] <- "Asian"
dat_check$race_eth[dat_check$Race == "More than one" & dat_check$Ethnicity =="Not Hispanic/Latino" ] <- "Multi-racial"
dat_check$race_eth[dat_check$Race == "Unknown or Not Reported" & dat_check$Ethnicity =="Not Hispanic/Latino" ] <- "Unknown or not reported"

dat_check$race_eth[dat_check$Race == "White" & dat_check$Ethnicity =="Unknown or Not Reported"] <- "White"
dat_check$race_eth[dat_check$Race == "Black or African Am." & dat_check$Ethnicity =="Unknown or Not Reported"] <- "Black or African American"
dat_check$race_eth[dat_check$Race == "Am. Indian/Alaskan Nat." & dat_check$Ethnicity =="Unknown or Not Reported" ] <- "Native American"
dat_check$race_eth[dat_check$Race == "Asian/Nat. Hawaiian/Othr Pacific Is." & dat_check$Ethnicity =="Unknown or Not Reported"] <- "Asian"
dat_check$race_eth[dat_check$Race == "More than one" & dat_check$Ethnicity =="Unknown or Not Reported" ] <- "Multi-racial"
dat_check$race_eth[dat_check$Race == "Unknown or Not Reported" & dat_check$Ethnicity =="Unknown or Not Reported" ] <- "Unknown or not reported"

dat_check$race_eth <- ordered(dat_check$race_eth, levels = c("White", "Black or African American"  , "Asian" ,
                                             "Multi-racial" , "Unknown or not reported and Hispanic","Multi-racial and Hispanic",
                                             "Black or African American and Hispanic", "White and Hispanic"))


```

## Unresitricted data
```{r, echo=FALSE}
unres<-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/unrestricted_gshearrer_4_19_2018_11_31_37.csv", header=T, sep=",")
myvars<-c("Subject","Gender","DDisc_SV_1mo_200","DDisc_SV_6mo_200","DDisc_SV_1yr_200","DDisc_SV_3yr_200","DDisc_SV_5yr_200",
             "DDisc_SV_10yr_200","DDisc_SV_1mo_40K","DDisc_SV_6mo_40K","DDisc_SV_1yr_40K","DDisc_SV_3yr_40K","DDisc_SV_5yr_40K",
             "DDisc_SV_10yr_40K","DDisc_AUC_200","DDisc_AUC_40K","ListSort_AgeAdj","CogFluidComp_AgeAdj","CogEarlyComp_AgeAdj",
             "CogTotalComp_AgeAdj","CogCrystalComp_AgeAdj","Endurance_AgeAdj",
             "GaitSpeed_Comp","Dexterity_AgeAdj","Strength_AgeAdj","Taste_AgeAdj")
unres<-unres[myvars]
unres$Subject<-unres$Subject
motion<-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/HCP1200-Motion-Summaries.csv", header=T, sep=",")
labels<-read.table("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/parcel_names.csv", header = T, sep = ",")
```


# joining individual sub data 
```{r, echo=FALSE}
data<-join(dat_check,unres)
dim(data)
head(data)
data$X<-as.factor(data$X)
names(data)
summary(as.factor(data$IC))
data<-join(data, labels)
dim(data)
summary(as.factor(data$Gordon.Label))
```

```{r}
quantile(data$PC)
data<-subset(data, data$PC > -4.100e+01)
sd(data$PC)

K=1.000e+00+1
hist(log10(K-data$PC), breaks = 100)
data$PC_log<-log10(K-data$PC)

hist(sqrt(data$centrality), breaks = 100)
data$centrality_sq<-sqrt(data$centrality)

hist(data$clustering, breaks = 100)
```


# Cleanup, center, ect
```{r, echo=FALSE}
cols <- c("Subject","Gender" ,"ZygosityGT", "Mother_ID","Father_ID","group","race_eth","modules","IC")

data %<>% mutate_at(cols, funs(factor(.)))
# str(data[100:114])
data$group <- ordered(data$group, levels = c("no", "ov", "ob"))
head(data)
```
# Motion data
```{r}
#motion<-motion[!duplicated(motion$Subject), ]
drops <- c("type")
motion<-motion[ , !(names(motion) %in% drops)]
head(motion)

motion<-motion %>%
    group_by(Subject) %>%
    summarise_all("mean")
summary(motion)
dat<-join(data, motion)
dim(data)
dim(dat)
```

## Contrasts for demographics
```{r, echo=FALSE}
demos<-data[!duplicated(data[,c('Subject')]),]
levels(demos$group)    
levels(demos$race_eth)
head(demos)
#          no  ov  ob
cons<- list(
  noVov = c(1, -1,  0),
  noVob = c(1,  0, -1),
  ovVob = c(0,  1, -1)
) 
```




# Covariates
## Age
```{r, echo=FALSE}
dm1<-lm(Age_c~group, dat=demos)
summary(dm1)
lsq_dm1 = lsmeans(dm1, "group")
contrast(lsq_dm1, cons, adjust='fdr')


violin(demos,demos$group,demos$Age_c)
describeBy(demos$Age_in_Yrs, demos$group)
## No difference in age 
```

# BMI
```{r, echo=FALSE}
dm2<-lm(BMI~group, data=demos)
lsq_dm2 = lsmeans(dm2, "group")
contrast(lsq_dm2, cons, adjust='fdr')
## Sanity check difference between the groups
violin(demos,demos$group,demos$BMI)
describeBy(demos$BMI, demos$group)
```

#HBA1c
```{r, echo=FALSE}
dm3<-lm(HBA1c_c~group, data=demos)
summary(dm3)
lsq_dm3 = lsmeans(dm3, "group")
contrast(lsq_dm3, cons, adjust='fdr')

violin(demos,demos$group,demos$HbA1C)
describeBy(demos$HbA1C, demos$group)
```


## sex
```{r, echo=FALSE}
chisq.test(table(demos$group, demos$Gender))
tapply(demos$group, demos$Gender, summary)

balloonplot(table(demos$group, demos$Gender), main ="Gender Frequencies", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, colmar=5, dotcolor=cbPalette)
```
## Race
```{r, echo=FALSE}
chisq.test(table(demos$group, demos$race_eth))
tapply(demos$group, demos$race_eth, summary)

balloonplot(table(demos$group, demos$race_eth), main ="Racial/Ethnic Frequencies", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, dotcolor=cbPalette, colmar=5)
```
# Models
```{r}
#          no  ov  ob
cons<- list(
  noVov = c(1, -1,  0),
  noVob = c(1,  0, -1),
  ovVob = c(0,  1, -1)
) 
hist(dat$clustering)
hist(log10(dat$motion))
dat$motion_log10<-log10(dat$motion)
hist(sqrt(dat$assortativity))
dat$assortativity_sqrt<-sqrt(dat$assortativity)
```

## From Tooley
C = age + sex + race + meanRMS + weight + SES + age∗SES
```{r}
f0<-lm(clustering ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + group, data=dat)
summary(f0)
lm.beta(f0)


lsq_f0 = lsmeans(f0, "group")
contrast(lsq_f0, cons, adjust='fdr')


ggplot(dat, aes(BMI, clustering, color = group, group = group)) +
  geom_point(alpha = 1/100)+ 
  geom_smooth(method = lm) + 
  scale_color_manual(values=cbPalette)+
  theme_classic()

violin(dat,dat$group,dat$clustering)
```

# BMI related to assortativity, quadratic 
```{r}
f2.0<-lm(sqrt(assortativity) ~ Age_c + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=dat)
summary(f2.0)
lm.beta(f2.0)

f2_df4<-lm(assortativity_sqrt ~ Age_c + HBA1c_c + race_eth + motion_log10 + weight +bs(BMI, df = 4, degree = 2), data=dat)
summary(f2)
lm.beta(f2)

f2_df3<-lm(assortativity_sqrt ~ Age_c + HBA1c_c + race_eth + motion_log10 + weight +bs(BMI, df = 3, degree = 2), data=dat)

f2_df2<-lm(assortativity_sqrt ~ Age_c + HBA1c_c + race_eth + motion_log10 + weight +bs(BMI, df = 2, degree = 2), data=dat)

f2_df0<-lm(assortativity_sqrt ~ Age_c + HBA1c_c + race_eth + motion_log10 + weight +bs(BMI,  degree = 2), data=dat)

lrtest(f2_df4, f2_df3)
lrtest(f2_df4, f2_df2)
lrtest(f2_df3, f2_df2) # no difference

lrtest(f2_df4, f2_df0)
lrtest(f2_df3, f2_df0) # no difference
lrtest(f2_df2, f2_df0) # no difference



AIC(f2_df4, f2_df3, f2_df2, f2_df0)
# df = 4 best

f2.1<-lm(assortativity_sqrt ~ Age_c + HBA1c_c + race_eth + motion_log10 + weight +group, data=dat)
summary(f2.1)
lm.beta(f2.1)

lrtest(f2.1, f2)
AIC(f2.1, f2)

lsq_f2.1 = lsmeans(f2.1, "group")
contrast(lsq_f2.1, cons, adjust='fdr')

#spline model is more parsimonious 
#bs(x, degree = 2))
ggplot(dat, aes(BMI, sqrt(assortativity))) +
  geom_point(shape=1)+ 
  geom_smooth()

ggplot(dat, aes(BMI, assortativity_sqrt)) +
  geom_point(alpha = 1/100)+ 
  geom_smooth()+
  geom_spline(aes(BMI), df = 4) + 
  scale_color_manual(values=cbPalette)+
  theme_classic()
```

```{r}
f3<-lm(clustering ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI*assortativity_sqrt, data=dat)
summary(f3) # BMI no longer significant

f3.1<-lm(assortativity_sqrt ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI*clustering, data=dat)
summary(f3.1)# BMI still significant <- assortativity is driving the differences in clustering coefficients]
```


```{r}
dat$Gordon.Label<-as.factor(dat$Gordon.Label)
summary(as.factor(dat$Gordon.Label))
```
```{r}
dat$comb_label[dat$Gordon.Label == "BrainStem"]<- "brain stem"

dat$comb_label[dat$Gordon.Label == "L_Auditory_5"]<- "auditory"
dat$comb_label[dat$Gordon.Label == "R_Auditory_17"  ] <- "auditory"

dat$comb_label[dat$Gordon.Label == "L_Caudate" ]<- "subcortical"
dat$comb_label[dat$Gordon.Label == "R_Caudate" ]<- "subcortical"
dat$comb_label[dat$Gordon.Label == "L_Putamen"]<- "subcortical"
dat$comb_label[dat$Gordon.Label == "R_Putamen" ]<- "subcortical"
dat$comb_label[dat$Gordon.Label == "L_Thalamus" ]<- "subcortical"
dat$comb_label[dat$Gordon.Label =="R_Thalamus" ]<- "subcortical"
dat$comb_label[dat$Gordon.Label ==  "L_VentralDiencephalon" ]    <- "subcortical"           
dat$comb_label[dat$Gordon.Label ==  "R_VentralDiencephalon"]<- "subcortical"
dat$comb_label[dat$Gordon.Label ==  "R_Amygdala"] <- "subcortical"

dat$comb_label[dat$Gordon.Label == "L_Cerebellum"] <- "cerebellum"
dat$comb_label[dat$Gordon.Label == "R_Cerebellum"] <- "cerebellum"

#L_CinguloOperc_15     L_CinguloOperc_19     L_CinguloOperc_20 L_CinguloOperc_7 R_CinguloOperc_40 
dat$comb_label[dat$Gordon.Label == "L_CinguloOperc_7" ] <- "CON"
dat$comb_label[dat$Gordon.Label == "L_CinguloOperc_15" ] <- "CON"
dat$comb_label[dat$Gordon.Label == "L_CinguloOperc_19"] <- "CON"
dat$comb_label[dat$Gordon.Label == "L_CinguloOperc_20" ] <- "CON"
dat$comb_label[dat$Gordon.Label == "R_CinguloOperc_40" ] <- "CON"
#L_Default_11          L_Default_16           L_Default_7  R_Default_26          R_Default_28  R_Default_36          R_Default_37
dat$comb_label[dat$Gordon.Label == "L_Default_11"] <- "DMN"
dat$comb_label[dat$Gordon.Label == "L_Default_16"] <- "DMN"
dat$comb_label[dat$Gordon.Label == "L_Default_7"] <- "DMN"
dat$comb_label[dat$Gordon.Label == "R_Default_26"] <- "DMN"
dat$comb_label[dat$Gordon.Label == "R_Default_28"] <- "DMN"
dat$comb_label[dat$Gordon.Label == "R_Default_36"] <- "DMN"
dat$comb_label[dat$Gordon.Label =="R_Default_37"] <- "DMN"
#L_DorsalAttn_13       L_DorsalAttn_17        L_DorsalAttn_9 R_DorsalAttn_27       R_DorsalAttn_28       R_DorsalAttn_30
dat$comb_label[dat$Gordon.Label == "L_DorsalAttn_13"] <- "DAN"
dat$comb_label[dat$Gordon.Label == "L_DorsalAttn_17"] <- "DAN"
dat$comb_label[dat$Gordon.Label == "L_DorsalAttn_9"] <- "DAN"
dat$comb_label[dat$Gordon.Label == "R_DorsalAttn_27"] <- "DAN"
dat$comb_label[dat$Gordon.Label == "R_DorsalAttn_28"] <- "DAN"
dat$comb_label[dat$Gordon.Label == "R_DorsalAttn_30"] <- "DAN"
# L_FrontoParietal_1    L_FrontoParietal_2    L_FrontoParietal_4 R_FrontoParietal_10   R_FrontoParietal_11 R_FrontoParietal_12   R_FrontoParietal_20   R_FrontoParietal_21 
dat$comb_label[dat$Gordon.Label == "L_FrontoParietal_1"] <- "FPN"
dat$comb_label[dat$Gordon.Label == "L_FrontoParietal_2"] <- "FPN"
dat$comb_label[dat$Gordon.Label == "L_FrontoParietal_4"] <- "FPN"
dat$comb_label[dat$Gordon.Label == "R_FrontoParietal_10"] <- "FPN"
dat$comb_label[dat$Gordon.Label == "R_FrontoParietal_11" ] <- "FPN"
dat$comb_label[dat$Gordon.Label ==  "R_FrontoParietal_12"] <- "FPN"
dat$comb_label[dat$Gordon.Label ==  "R_FrontoParietal_20"] <- "FPN"
dat$comb_label[dat$Gordon.Label == "R_FrontoParietal_21"] <- "FPN"

dat$comb_label[dat$Gordon.Label == "R_MedialParietal_5"] <- "MPN"
#L_None_21              L_None_7 R_None_34  
dat$comb_label[dat$Gordon.Label == "L_None_21"] <- "none"
dat$comb_label[dat$Gordon.Label == "L_None_7"] <- "none"
dat$comb_label[dat$Gordon.Label == "R_None_34" ] <- "none"
#L_SMhand_15 L_SMhand_5 R_SMhand_37 
dat$comb_label[dat$Gordon.Label == "L_SMhand_15"] <- "smHand"
dat$comb_label[dat$Gordon.Label == "L_SMhand_5"] <- "smHand"
dat$comb_label[dat$Gordon.Label == "R_SMhand_37"] <- "smHand"
#L_SMmouth_2           L_SMmouth_4  R_SMmouth_7 
dat$comb_label[dat$Gordon.Label == "L_SMmouth_2"] <- "smMouth"
dat$comb_label[dat$Gordon.Label == "L_SMmouth_4"] <- "smMouth"
dat$comb_label[dat$Gordon.Label == "R_SMmouth_7"] <- "smMouth"
#L_VentralAttn_1       L_VentralAttn_6 R_VentralAttn_12      R_VentralAttn_19
dat$comb_label[dat$Gordon.Label == "L_VentralAttn_1"] <- "VAN"
dat$comb_label[dat$Gordon.Label == "L_VentralAttn_6"] <- "VAN"
dat$comb_label[dat$Gordon.Label == "R_VentralAttn_12"] <- "VAN"
dat$comb_label[dat$Gordon.Label == "R_VentralAttn_19"] <- "VAN"
#L_Visual_1           L_Visual_13           L_Visual_15           L_Visual_16           L_Visual_17            L_Visual_3            L_Visual_9
#R_Visual_25           R_Visual_26 R_Visual_27           R_Visual_29           R_Visual_35           R_Visual_37           R_Visual_39 
dat$comb_label[dat$Gordon.Label == "L_Visual_1"] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "L_Visual_13"] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "L_Visual_15"] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "L_Visual_16"] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "L_Visual_17" ] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "L_Visual_3"] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "L_Visual_9" ] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "R_Visual_25" ] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "R_Visual_26" ] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "R_Visual_27" ] <- "VIZ"
dat$comb_label[dat$Gordon.Label ==   "R_Visual_29"] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "R_Visual_35"] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "R_Visual_37" ] <- "VIZ"
dat$comb_label[dat$Gordon.Label == "R_Visual_39" ] <- "VIZ"

dat$comb_label<-as.factor(dat$comb_label)
summary(dat$comb_label)
```
```{r}
dat_net <- transform(dat, mods = interaction(group, comb_label))
head(dat_net)
```

```{r}
f5<-lm(clustering ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + comb_label*group, data = dat_net, na.action = na.omit)

f5.1<-lm(clustering ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + comb_label + group, data = dat_net, na.action = na.omit)
anova(f5, f5.1)
```

```{r}
CC.net.gls <- gls(clustering ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + mods, data = dat_net, na.action = na.omit) #scaled so these are the betas
CC.net.emm <- emmeans(CC.net.gls, "mods")
CC.net.fac <- update(CC.net.emm, levels = list(
                group = c("no","ov","ob"),
                comb_label = c("auditory", "brain stem", "cerebellum","CON","DAN","DMN","FPN","MPN","none","smHand","smMouth", "subcortical","VAN","VIZ")))

contrast(CC.net.fac, "pairwise", by = "comb_label", adjust = "fdr")

pwpm(CC.net.fac, by = "comb_label", adjust = "fdr")
eff_size(CC.net.fac, sigma = sigma(CC.net.gls), edf = 16847, by = "comb_label")
```
```{r}
CON<-subset(dat_net, dat_net$comb_label == "subcortical")
violin(CON, CON$group, CON$clustering)
```
```{r}
names(dat_net)
```
```{r}
summary(dat_net$module)
dat_mod<-subset(dat_net, dat_net$module != 7)
dat_mod<-subset(dat_mod, dat_mod$module != 8)
dat_mod$module<-as.factor(dat_mod$module)
summary(dat_mod$module)

dat_mod <- transform(dat_mod, mods = interaction(group, module))
head(dat_mod)
```

```{r}
CC.mod.gls <- gls(clustering ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + mods, data = dat_mod, na.action = na.omit) #scaled so these are the betas
CC.mod.emm <- emmeans(CC.mod.gls, "mods")
CC.mod.fac <- update(CC.mod.emm, levels = list(
                group = c("no","ov","ob"),
                module = c("0","1", "2", "3","4","5","6")))

contrast(CC.mod.fac, "pairwise", by = "module", adjust = "fdr")

pwpm(CC.mod.fac, by = "module", adjust = "fdr")
eff_size(CC.net.fac, sigma = sigma(CC.net.gls), edf = 16847, by = "comb_label")
```

```{r}
dat_no<-subset(dat, dat$group == "no")
balloonplot(table(dat_no$comb_label, dat_no$modules), main ="module", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, dotcolor=cbPalette, colmar=5)
dat_ov<-subset(dat, dat$group == "ov")
balloonplot(table(dat_ov$comb_label, dat_ov$modules), main ="module", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, dotcolor=cbPalette, colmar=5)
dat_ob<-subset(dat, dat$group == "ob")
balloonplot(table(dat_ob$comb_label, dat_ob$modules), main ="module", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, dotcolor=cbPalette, colmar=5)
library(fossil)
rand.index(as.numeric(dat_no$modules), as.numeric(dat_ov$modules))
```


```{r}
names(dat_net)
dems<-c("Subject","Age_c","Gender","HBA1c_c","race_eth","motion_log10","weight", "group", "BMI")
g<-dat_net[dems]
head(g)
g<-g[!duplicated(g), ]
l<-dat_net[c('Subject', 'clustering', 'comb_label')]

subject_clust <-l %>%
  group_by(Subject, comb_label) %>%
  summarise_all(mean)
subject_clust

library(tidyr)
sub_cluster_wide<-spread(subject_clust, key = comb_label, value = clustering)
pew_pew<-join(sub_cluster_wide, g)
pew_pew
```

```{r}
#Auditory
auditory <- lm(auditory ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
summary(auditory)
#cerebellum
cerebellum <- lm(cerebellum ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
#CON
CON <- lm(CON ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
#DAN
DAN <- lm(DAN ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
#DMN
DMN<- lm(DMN ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
#FPN
FPN <- lm(FPN ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
#MPN
MPN <- lm(MPN ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
#subcortical
subcortical <- lm(subcortical ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
#VAN
VAN <- lm(VAN ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
#VIZ
VIZ <- lm(VIZ ~ Age_c + Gender + HBA1c_c + race_eth + motion_log10 + weight + BMI, data=pew_pew)
```



```{r}
#write scaled betas to outfile
models<-list(auditory, cerebellum, CON, DAN, DMN, FPN, MPN, subcortical, VAN, VIZ)
bmi_betas <- lapply(models, function(x) { lm.beta(x)$standardized.coefficients[14]})
bmi_se <- lapply(models,function(x) { summary(x)$coefficients[14,2]})
bmi_pvals <- lapply(models,function(x) { summary(x)$coefficients[14,4]})
bmi_scaled_net_betas <- as.data.frame(cbind(unlist(bmi_betas),unlist(bmi_se), unlist(bmi_pvals)))
colnames(bmi_scaled_net_betas) <- c("bmi_betas", "bmi_se", "bmi_pvals")
bmi_scaled_net_betas$bmi_pvals_fdr <- p.adjust(bmi_scaled_net_betas$bmi_pvals, method = "fdr")
bmi_scaled_net_betas
```






```{r}
#took out FC
fit_function<-function(y,data){
  fit<-lm(y~group*IC+Age_c+HBA1c_c+Gender+race_eth, data=data)
  test.emm <- emmeans(fit, "group")
  contest<-emmeans(test.emm, pairwise ~ group)
  test.emm.s <- update(contest$contrasts, infer = c(TRUE, TRUE))
  return(summary(test.emm.s))
}

dfer<-function(X,Y){
  df<-data.frame(X,Y, stringsAsFactors=FALSE)
  return(df)
}
```


```{r}
# IC
warp <- transform(data, mods = interaction(group, IC))
head(warp)
# functional 
warp_func <- transform(graph_df, mods = interaction(group, area))
head(warp_func)
# mod
summary(graph_df$module)
mdf<-subset(graph_df, graph_df$module != 7)
mdf<-subset(mdf, mdf$module != 8)
mdf$module<-factor(mdf$module)
warp_mod <- transform(mdf, mods = interaction(group, module))
```

# 3.3 Clustering coefficient
## 3.3.1 Nodal
After correcting for multiple comparisons (n=300), there were no differences in clustering coefficient between the BMI groups. Using a less stringent correction for multiple comparison (n=3 per node), in node 22 the aBMI group exhibited higher clustering coefficient compared to the hBMI group (d = 0.64, SE = 0.22, sigma = 0.07, pFDR3 = 0.01). In node 73, the aBMI group has higher clustering coefficient compared to the vhBMI group (d = 0.49, SE = 0.19 pFDR3= 0.01), and the hBMI group showed increased clustering coefficient compared the the vhBMI group (d = 0.63, SE= 0.19, sigma = 0.07, pFDR3= 0.004). 
```{r}
baseCC<-lm(clustering ~ group+IC+Gender+race_eth+HbA1C, data = data, na.action = na.omit)
confint(baseCC)
install.packages("sjstats")
library(sjstats)
anova_stats(anova(baseCC))
CC.emm<-emmeans(baseCC, "group")
contrast(CC.emm, "pairwise", adjust = "fdr")
eff_size(CC.emm, sigma = sigma(baseCC), edf = 16807)

base_CCp<-ggplot(data, aes(group, clustering))+
  geom_violin(aes(fill = group), draw_quantiles = c(0.25, 0.5, 0.75))+
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))

base_CCp
```


```{r}
CC.IC.gls <- gls(clustering ~ mods+Gender+race_eth+HbA1C, data = warp, na.action = na.omit)
CC.IC.emm <- emmeans(CC.IC.gls, "mods")
CC.IC.fac <- update(CC.IC.emm, levels = list(
                group = c("no", "overweight", "obese"), 
                area = c("0","1","2","3","4","5","6","7","8","9","10",
                         "11","12","13","14","15","16","17","18","19","20",
                         "21","22","23","24","25","26","27","28","29","30",
                         "31","32","33","34","35","36","37","38","39","40",
                         "41","42","43","44","45","46","47","48","49","50",
                         "51","52","53","54","55","56","57","58","59","60",
                         "61","62","63","64","65","66","67","68","69","70",
                         "71","72","73","74","75","76","77","78","79","80",
                         "81","82","83","84","85","86","87","88","89","90",
                         "91","92","93","94","95","96","97","98","99")))

contrast(CC.IC.fac, "pairwise", by = "area", adjust = "fdr")
pwpm(CC.IC.fac, by = "area", adjust = "fdr")
eff_size(CC.IC.fac, sigma = sigma(CC.IC.gls), edf = 16609, by = "area")
```

```{r}
IC22<-subset(warp, warp$IC == "IC_22")
IC73<-subset(warp, warp$IC == "IC_73")

p73 <-ggplot(IC73, aes(mods, clustering))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))

p22 <-ggplot(IC22, aes(mods, clustering))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))


ggarrange(p22, p73, 
          labels = c("node 22: middle temporal gyrus", "node 73: cerebellum"),
          ncol = 2)
```
# 3.3.2 Functional Networks
No differences in any functional networks were seen between the BMI groups. 
```{r}
F.CC.gls <- gls(clustering ~ mods, data = warp_func)
F.CC.emm <- emmeans(F.CC.gls, "mods")
F.CC.fac <- update(F.CC.emm, levels = list(
                group = c("no", "overweight", "obese"), 
                area = c("","Amygdala", "Auditory", "BrainStem", "Caudate", "Cerebellum", "CinguloOperc",
                         "Default", "DorsalAttn", "FrontoParietal", "MedialParietal", "Putamen",
                         "Smhand", "Smmouth", "Thalamus", "VentralAttn", "VentralDiencephalon", "Visual")))

contrast(F.CC.fac, "pairwise", by = "area", adjust = "fdr")
pwpm(F.CC.fac, by = "area", adjust = "fdr")
eff_size(F.CC.fac, sigma = sigma(CC.IC.gls), edf = 16609, by = "area")

```
## 3.3.3 Modules
Between the sensory modules, aBMI module 2 trended towards increased clustering coefficient compared to the vhBMI module 4 (d = 0.86, SE = 0.41, signma = 0.06, pFDR3= 0.09). The aBMI group additionally showed increased clustering coefficients within the subcortical module (module 5) compared to the vhBMI subcortical module (module 6) (d = 1.298, SE = 0.506, sigma = 0.04, pFDR3= 0.03).

```{r}
# mod
summary(graph_df$module)
mdf<-subset(graph_df, graph_df$module != 7)
mdf<-subset(mdf, mdf$module != 8)
mdf$module<-factor(mdf$module)
```




### visual 
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$visual <- NA
warp_mod[warp_mod$mods == 'no.0', "visual"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.0', "visual"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.0', "visual"] <- 'vhBMI4'

M.CC0.gls <- gls(clustering ~ visual, data = warp_mod, na.action = na.omit)
M.CC0.emm <- emmeans(M.CC0.gls, "visual")

contrast(M.CC0.emm, "pairwise",  adjust = "fdr")
pwpm(M.CC0.emm, adjust = "fdr")
eff_size(M.CC0.emm, sigma = sigma(M.CC0.gls), edf = 21)
```

### Sensory 
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

# no.2.5 vs. ov.2.6 vs. ob.4.6
warp_mod$sensory <- NA
warp_mod[warp_mod$mods == 'no.2', "sensory"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.2', "sensory"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.4', "sensory"] <- 'vhBMI4'

Msen.CC0.gls <- gls(clustering ~ sensory, data = warp_mod, na.action = na.omit)
Msen.CC0.emm <- emmeans(Msen.CC0.gls, "sensory")

contrast(Msen.CC0.emm, "pairwise",  adjust = "fdr")
pwpm(Msen.CC0.emm, adjust = "fdr")
eff_size(Msen.CC0.emm, sigma = sigma(Msen.CC0.gls), edf = 21)
```


### submod check
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))
colnames(warp_mod)
# no.2.5 vs. ov.2.6 vs. ob.4.6
warp_mod$sensory <- NA
warp_mod[warp_mod$mods == 'no.2', "sensory"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.2', "sensory"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.4', "sensory"] <- 'vhBMI4'
warp_mod$sensory<-factor(warp_mod$sensory)
warp_mod$sub_modules<-factor(warp_mod$sub_modules)
warp_mod$IC<-factor(warp_mod$IC)
warp_smod<-warp_mod[complete.cases(warp_mod$sensory),]
warp_smod[] <- lapply(warp_smod, function(x) if(is.factor(x)) factor(x) else x)

balloonplot(table(warp_smod$area, warp_smod$sensory), main =" ", xlab ="", ylab="",
            label = TRUE, show.margins = FALSE, colsrt = 90,text.size=1.5 ,dotsize = 10, dotcolor=cbPalette, colmar=5)
table(warp_smod$IC, warp_smod$sub_modules, warp_smod$sensory)
```

```{r}
warp_mod<-warp_mod[complete.cases(warp_mod$sensory), ] 
pSen <-ggplot(warp_mod, aes(sensory, clustering))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
pSen
```

### DMN
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$DMN <- NA
warp_mod[warp_mod$mods == 'no.1', "DMN"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.1', "DMN"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.1', "DMN"] <- 'vhBMI4'

CC0.gls <- gls(clustering ~ DMN, data = warp_mod, na.action = na.omit)
CC0.emm <- emmeans(CC0.gls, "DMN")

contrast(CC0.emm, "pairwise",  adjust = "fdr")
```

### subcortical
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$subcort <- NA
warp_mod[warp_mod$mods == 'no.5', "subcort"] <- 'aBMI5'
warp_mod[warp_mod$mods == 'overweight.6', "subcort"] <- 'hBMI6'
warp_mod[warp_mod$mods == 'obese.6', "subcort"] <- 'vhBMI6'


Msub.CC0.gls <- gls(clustering ~ subcort, data = warp_mod, na.action = na.omit)
Msub.CC0.emm <- emmeans(Msub.CC0.gls, "subcort")

contrast(Msub.CC0.emm, "pairwise",  adjust = "fdr")
pwpm(Msub.CC0.emm, adjust = "fdr")
eff_size(Msub.CC0.emm, sigma = sigma(Msub.CC0.gls), edf = 21)

```

```{r}
warp_mod<-warp_mod[complete.cases(warp_mod$subcort), ] 

pSub <-ggplot(warp_mod, aes(subcort, clustering))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))

```

```{r}
modCC<-ggarrange(pSen, pSub, 
          labels = c("Sensory module", "Subcortical module"),
          ncol = 2)
modCC
```

### other
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$other <- NA
warp_mod[warp_mod$mods == 'no.3', "other"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.3', "other"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.3', "other"] <- 'vhBMI4'


CC0.gls <- gls(clustering ~ other, data = warp_mod, na.action = na.omit)
CC0.emm <- emmeans(CC0.gls, "other")

contrast(CC0.emm, "pairwise",  adjust = "fdr")
```

# 3.6 Betweenness centrality
## 3.6.1 Nodal
No differences were detected between BMI groups after correcting for multiple comparisons (n=300). Using the less stringent multiple comparison correction (n=3),in node 13 the aBMI group had higher centrality compared to the hBMI group (d = 0.14, SE = 0.07, sigma = 0.04, pFDR3= 0.05), and the vhBMI had higher centrality compared to the hBMI group (d = -0.24, SE = 0.06, sigma = 0.04, pFDR3= 0.01). In node 17, the hBMI had higher centrality compared to both the aBMI (d = -0.12, SE= 0.05, sigma = 0.04, pFDR3= 0.03) and vhBMI (d = 0.15, SE = 0.06, sigma = 0.04, pFDR3= 0.03) groups. 
In node 41, the aBMI had higher centrality compared to the hBMI (d = 0.15, SE = 0.07, sigma = 0.04, pFDR3= 0.02), and the vhBMI group exhibited higher centrality compared to the hBMI group (d = -0.29, SE = 0.08, sigma = 0.04, pFDR3= 0.001). 
In node 50, the hBMI group exhibited lower centrality compared to both the aBMI (d = 0.15, SE = 0.05, sigma = 0.04, pFDR3= 0.01) and the vhBMI (d = -0.12, SE=0.03, sigma = 0.04, pFDR3= 0.08) groups. 
In node 86, the vhBMI group exhibited decreased centrality compared to both the aBMI (d = 0.15, SE = 0.06, sigma = 0.04, pFDR3= 0.02) and the hBMI (d = 0.19, SE = 0.06, sigma = 0.04, pFDR3= 0.01) groups. 
```{r}
baseCen<-lm(centrality_sq ~ group+IC+Gender+race_eth+HbA1C, data = data, na.action = na.omit)
anova(baseCen)
Cen.emm<-emmeans(baseCen, "group")
contrast(Cen.emm, "pairwise", adjust = "fdr")
eff_size(Cen.emm, sigma = sigma(baseCen), edf = 16807)

base_Cenp<-ggplot(data, aes(group, centrality_sq))+
  geom_violin(aes(fill = group), draw_quantiles = c(0.25, 0.5, 0.75))+
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))

base_Cenp
```


```{r}
IC.Cen.gls <- gls(centrality_sq ~ mods+Gender+race_eth+HbA1C, data = warp, na.action = na.omit)
IC.Cen.emm <- emmeans(IC.Cen.gls, "mods")
IC.Cen.fac <- update(IC.Cen.emm, levels = list(
                group = c("no", "overweight", "obese"), 
                area = c("0","1","2","3","4","5","6","7","8","9","10",
                         "11","12","13","14","15","16","17","18","19","20",
                         "21","22","23","24","25","26","27","28","29","30",
                         "31","32","33","34","35","36","37","38","39","40",
                         "41","42","43","44","45","46","47","48","49","50",
                         "51","52","53","54","55","56","57","58","59","60",
                         "61","62","63","64","65","66","67","68","69","70",
                         "71","72","73","74","75","76","77","78","79","80",
                         "81","82","83","84","85","86","87","88","89","90",
                         "91","92","93","94","95","96","97","98","99")),
                adjust = "fdr")

contrast(IC.Cen.fac, "pairwise", by = "area", adjust = "fdr")
pwpm(IC.Cen.fac, adjust = "fdr", by = "area")
eff_size(IC.Cen.fac, sigma = sigma(Msub.CC0.gls), edf = 16609, by = "area")
```



```{r}
IC13<-subset(warp, warp$IC == "IC_13")
pIC13 <-ggplot(IC13, aes(mods, centrality))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
pIC13
IC17<-subset(warp, warp$IC == "IC_17")
pIC17 <-ggplot(IC17, aes(mods, centrality))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
pIC17
IC41<-subset(warp, warp$IC == "IC_41")
pIC41 <-ggplot(IC41, aes(mods, centrality))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
pIC41
IC50<-subset(warp, warp$IC == "IC_50")
pIC50 <-ggplot(IC50, aes(mods, centrality))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
pIC50

IC86<-subset(warp, warp$IC == "IC_86")
pIC86 <-ggplot(IC86, aes(mods, centrality))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
pIC86

pCen1<-ggarrange(pIC13, pIC17,
          labels = c("FrontoParietal", "DAN"),
          ncol = 2)

pCen2<-ggarrange(pIC41, pIC50,
          labels = c("Cerebellum","Cerebellum"),
          ncol = 2)

pCen3<-ggarrange(pIC86,
          labels = c("Thalamus"),
          ncol = 1)
```


## 3.6.2 Functional Networks
No differences in any functional networks were seen between the BMI groups.
```{r}
Cen.gls <- gls(centrality_log ~ mods, data = warp_func)
Cen.emm <- emmeans(Cen.gls, "mods")
Cen.fac <- update(Cen.emm, levels = list(
                group = c("no", "overweight", "obese"), 
                area = c("","Amygdala", "Auditory", "BrainStem", "Caudate", "Cerebellum", "CinguloOperc",
                         "Default", "DorsalAttn", "FrontoParietal", "MedialParietal", "Putamen",
                         "Smhand", "Smmouth", "Thalamus", "VentralAttn", "VentralDiencephalon", "Visual")))

# contrast(Cen.fac, "pairwise", by = "area", adjust = "fdr")
eff_size(Cen.emm, sigma = sigma(Cen.gls), edf = 300)

```

## 3.6.3 Module 
The aBMI visual module (module 0) showed increased betweenness centrality compared to the vhBMI visual module (module 0) (d = 1.71, SE = 0.71, sigma = 0.20, pFDR3= 0.009). The hBMI visual module (module 0) also showed increased betweenness centrality compared to the vhBMI visual module (d = 1.76, SE = 0.62, sigma = 0.20, pFDR3= 0.009).
### visual 
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$visual <- NA
warp_mod[warp_mod$mods == 'no.0', "visual"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.0', "visual"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.0', "visual"] <- 'vhBMI4'

M.Cen0.gls <- gls(centrality_log ~ visual, data = warp_mod, na.action = na.omit)
M.Cen0.emm <- emmeans(M.Cen0.gls, "visual")

contrast(M.Cen0.emm, "pairwise",  adjust = "fdr")
eff_size(M.Cen0.emm, sigma = sigma(M.Cen0.gls), edf = 21)
```

```{r}
warp_mod<-warp_mod[complete.cases(warp_mod$visual), ] 

VizCenp<-ggplot(warp_mod, aes(visual, centrality))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Clustering Coefficient")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
VizCenp

```
### Sensory 
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$sensory <- NA
warp_mod[warp_mod$mods == 'no.2', "sensory"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.2', "sensory"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.4', "sensory"] <- 'vhBMI4'

Cen0.gls <- gls(centrality_log ~ sensory, data = warp_mod, na.action = na.omit)
Cen0.emm <- emmeans(Cen0.gls, "sensory")

contrast(Cen0.emm, "pairwise",  adjust = "fdr")
```
### DMN
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$DMN <- NA
warp_mod[warp_mod$mods == 'no.1', "DMN"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.1', "DMN"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.1', "DMN"] <- 'vhBMI4'

Cen0.gls <- gls(centrality_log ~ DMN, data = warp_mod, na.action = na.omit)
Cen0.emm <- emmeans(Cen0.gls, "DMN")

contrast(Cen0.emm, "pairwise",  adjust = "fdr")
```
### subcortical
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$subcort <- NA
warp_mod[warp_mod$mods == 'no.5', "subcort"] <- 'aBMI5'
warp_mod[warp_mod$mods == 'overweight.6', "subcort"] <- 'hBMI6'
warp_mod[warp_mod$mods == 'obese.6', "subcort"] <- 'vhBMI6'


Cen0.gls <- gls(centrality_log ~ subcort, data = warp_mod, na.action = na.omit)
Cen0.emm <- emmeans(Cen0.gls, "subcort")

contrast(Cen0.emm, "pairwise",  adjust = "fdr")
```
### other
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$other <- NA
warp_mod[warp_mod$mods == 'no.3', "other"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.3', "other"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.3', "other"] <- 'vhBMI4'


Cen0.gls <- gls(centrality_log ~ other, data = warp_mod, na.action = na.omit)
Cen0.emm <- emmeans(Cen0.gls, "other")

contrast(Cen0.emm, "pairwise",  adjust = "fdr")
```


# 3.4 Participation coefficient
## 3.4.1 Nodal
No differences between groups by nodal participation coefficient were observed with the more stringent (n=300) correction. Using the less stringent (n=3) correction for multiple comparisons, in node 13  the hBMI group exhibited higher participation coefficient compared to both the aBMI (d = -0.48, SE = 0.20, sigma = 0.31 , pFDR3= 0.03) and the vhBMI groups (d = 0.74, SE = 0.26, sigma = 0.31, pFDR3= 0.01). In area 32, the hBMI again showed increased participation coefficient compared to the aBMI group (d = -0.39, SE =0.16, sigma = 0.31 pFDR3= 0.04). 
```{r}
basePC<-lm(PC_log ~ group+IC+Gender+race_eth+HbA1C, data = data, na.action = na.omit)
anova(basePC)
anova_stats(anova(basePC))
summary(basePC)
PC.emm<-emmeans(basePC, "group")
contrast(PC.emm, "pairwise", adjust = 'fdr')
eff_size(PC.emm, sigma = sigma(basePC), edf = 16807)

base_PCp<-ggplot(data, aes(group, PC_log))+
  geom_violin(aes(fill = group), draw_quantiles = c(0.25, 0.5, 0.75))
base_PCp
```

```{r}
# colnames(warp)
# describeBy(warp$PC_z, warp$group)
# warp<-subset(warp, warp$PC_z > -0.03)

IC.PC.gls <- gls(PC_log ~ mods+Gender+race_eth+HbA1C, data = warp, na.action = na.omit)
IC.PC.emm <- emmeans(IC.PC.gls, "mods")
IC.PC.fac <- update(IC.PC.emm, levels = list(
                group = c("no", "ov", "ob"), 
                area = c("0","1","2","3","4","5","6","7","8","9","10",
                         "11","12","13","14","15","16","17","18","19","20",
                         "21","22","23","24","25","26","27","28","29","30",
                         "31","32","33","34","35","36","37","38","39","40",
                         "41","42","43","44","45","46","47","48","49","50",
                         "51","52","53","54","55","56","57","58","59","60",
                         "61","62","63","64","65","66","67","68","69","70",
                         "71","72","73","74","75","76","77","78","79","80",
                         "81","82","83","84","85","86","87","88","89","90",
                         "91","92","93","94","95","96","97","98","99")))

contrast(IC.PC.fac, "pairwise", by = "area", adjust = "fdr")
eff_size(IC.PC.fac, sigma = sigma(IC.PC.gls), edf = 16609, by ="area")
```

```{r}
#node13, node32
warp$PC_z<-scale(warp$PC)

IC13<-subset(warp, warp$IC == "IC_13")
pIC13<-ggplot(IC13, aes(mods, PC_z))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Participation Coefficient (z-score)")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
# pIC13

IC32<-subset(warp, warp$IC == "IC_32")
pIC32<-ggplot(IC32, aes(mods, PC_z))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Participation Coefficient (z-score)")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
# pIC32
PC_nodes<-ggarrange(pIC13, pIC32,
                    labels = c("DAN", "FrontoParietal"),
                    ncol = 2)
```
## 3.4.2 Functional Networks
Within the auditory functional network the vhBMI group showed decreased participation coefficient compared to both the aBMI (d = 3.04, SE = 1.42, sigma = 0.13, pFDR= 0.05) and the hBMI groups (d =3.07, SE = 1.42, sigma = 0.13, pFDR= 0.05). The participation coefficient in the somatosensory hand network for the vhBMI was lower compared to the aBMI (d = 2.40, SE = 0.70, sigma = 0.13, pFDR= 0.002) and the hBMI (d = 2.33, SE = 0.71, sigma = 0.13, pFDR= 0.002) groups. This pattern was also observed in the somatosensory mouth network, with the vhBMI showing a lower participation coefficient compared to the aBMI group (d = 2.60, SE = 1.01, sigma = 0.13, pFDR= 0.01) and the hBMI (d = 2.61, SE = 1.01, sigma = 0.13, pFDR= 0.01) group.  
```{r}
# warp_func<-subset(warp_func, warp_func$PC_z > -3)
# colnames(warp_func)
F.PC.gls <- gls(PC_sq ~ mods, data = warp_func, na.action = na.omit)
F.PC.emm <- emmeans(F.PC.gls, "mods")
F.PC.fac <- update(F.PC.emm, levels = list(
                group = c("no", "overweight", "obese"), 
                area = c("","Amygdala", "Auditory", "BrainStem", "Caudate", "Cerebellum", "CinguloOperc",
                         "Default", "DorsalAttn", "FrontoParietal", "MedialParietal", "Putamen",
                         "Smhand", "Smmouth", "Thalamus", "VentralAttn", "VentralDiencephalon", "Visual")))

contrast(F.PC.fac, "pairwise", by = "area", adjust = "fdr")

eff_size(F.PC.fac, sigma = sigma(F.PC.gls), edf = 246, by ="area")

aud<-subset(warp_func, warp_func$area == "Auditory")
summary(aud$IC)
```

```{r}
#node13, node32
warp_func$PC_z<-scale(warp_func$PC)
library(psych)
aud<-subset(warp_func, warp_func$area == "Auditory")
aud<-aud[complete.cases(aud$area), ] 

pAud<-ggplot(aud, aes(mods, PC_z))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Participation Coefficient (z-score)")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))

pAud

smH<-subset(warp_func, warp_func$area ==  "Smhand")
smH$mods<-factor(smH$mods)
head(smH)
smHp<-violin(smH, smH$mods, smH$PC_z)
smHp

pHand<-ggplot(smH, aes(mods, PC_z))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Participation Coefficient (z-score)")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))

pHand

smM<-subset(warp_func, warp_func$area ==  "Smmouth")
smM$mods<-factor(smM$mods)
smMp<-violin(smM, smM$mods, smM$PC_z)
pMouth<-ggplot(smM, aes(mods, PC_z))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Participation Coefficient (z-score)")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))

pMouth

```

## 3.4.3 Module
Within the visual modules, the vhBMI showed lower participation coefficients compared to both the aBMI (d = -3.13, SE = 0.71, sigma = 0.07, pFDR< 0.0001) and the hBMI groups (d = -2.78, SE = 0.70, sigma = 0.07, pFDR= 0.0001). Conversely, the participation coefficient for the vhBMI was higher in the sensory module (module 4) compared to the aBMI (module 2) (d = 3.97, SE = 0.28, sigma = 0.08, pFDR< 0.0001 ) and hBMI (module 2) (d = 3.86, SE = 0.71, sigma = 0.08 pFDR< 0.0001). 
```{r}
head(mdf)
x<-summary(mdf$module)

write.table(mdf, "~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/modules_numb.csv", sep=",", row.names = F)
```
#### correcting for module
Regressing module size from the original PC is an alternative to PCnorm. 

This is done by constructing a linear regression model where PC of nodes constitute the dependent variable, and the module size associated with each node is the independent variable. 
Subtracting the fit of the regression model from the original PC results in a residual PC score. 

Within this regression framework: 
  * positive residual PC score is observed for nodes with participation that is higher than expected because of module size effects    alone
  * whereas negative residual PC is observed for nodes with participation that is lower than expected because of module size
Z   * Residual PC close to zero indicates that nodes are strongly correlated with module size. 

Another alternative to PCnorm is to exclude intramodular connectivity altogether. This can be achieved by quantifying a node’s between-module degree, that is, the number of connections from node i to all other nodes that does not belong to node i’s module. These additional measures may be useful but require further investigation.

```{r}
head(data)
data_test <- transform(data, mods = interaction(group, modules))
summary(data_test$mods)
data_test$mod_numb[data_test$mods == "no.0"] <- 4
data_test$mod_numb[data_test$mods == "no.1"] <- 27
data_test$mod_numb[data_test$mods == "no.2"] <- 26
data_test$mod_numb[data_test$mods == "no.3"] <- 18
data_test$mod_numb[data_test$mods == "no.4"] <- 7
data_test$mod_numb[data_test$mods == "no.5"] <- 11
data_test$mod_numb[data_test$mods == "no.6"] <- 3

data_test$mod_numb[data_test$mods == "ov.0"] <- 4
data_test$mod_numb[data_test$mods == "ov.1"] <- 23
data_test$mod_numb[data_test$mods == "ov.2"] <- 25
data_test$mod_numb[data_test$mods == "ov.3"] <- 11
data_test$mod_numb[data_test$mods == "ov.4"] <- 7
data_test$mod_numb[data_test$mods == "ov.5"] <- 14
data_test$mod_numb[data_test$mods == "ov.6"] <- 9

data_test$mod_numb[data_test$mods == "ob.0"] <- 16
data_test$mod_numb[data_test$mods == "ob.1"] <- 25
data_test$mod_numb[data_test$mods == "ob.2"] <- 13
data_test$mod_numb[data_test$mods == "ob.3"] <- 6
data_test$mod_numb[data_test$mods == "ob.4"] <- 9
data_test$mod_numb[data_test$mods == "ob.5"] <- 14
summary(data_test$mod_numb)

vis_data<-subset(data_test, data_test$modules == 0)
length(vis_data$PC)
test_model<-lm(PC ~ mod_numb, data = vis_data, na.action = na.omit)
summary(test_model)
vis_data$resid_PC<-test_model$residuals
hist(vis_data$resid_PC)
test_model1<-lm(resid_PC ~ group, data = vis_data, na.action = na.omit)
summary(test_model1)
describeBy(vis_data$resid_PC, vis_data$group)
violin(vis_data, vis_data$group, vis_data$resid_PC)
```

### visual 
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))
summary(warp_mod$mods)
warp_mod$mod_numb[warp_mod$mods == "no.0"] <- 4
warp_mod$mod_numb[warp_mod$mods == "no.1"] <- 27
warp_mod$mod_numb[warp_mod$mods == "no.2"] <- 26
warp_mod$mod_numb[warp_mod$mods == "no.3"] <- 18
warp_mod$mod_numb[warp_mod$mods == "no.4"] <- 7
warp_mod$mod_numb[warp_mod$mods == "no.5"] <- 11
warp_mod$mod_numb[warp_mod$mods == "no.6"] <- 3

warp_mod$mod_numb[warp_mod$mods == "overweight.0"] <- 4
warp_mod$mod_numb[warp_mod$mods == "overweight.1"] <- 23
warp_mod$mod_numb[warp_mod$mods == "overweight.2"] <- 25
warp_mod$mod_numb[warp_mod$mods == "overweight.3"] <- 11
warp_mod$mod_numb[warp_mod$mods == "overweight.4"] <- 7
warp_mod$mod_numb[warp_mod$mods == "overweight.5"] <- 14
warp_mod$mod_numb[warp_mod$mods == "overweight.6"] <- 9

warp_mod$mod_numb[warp_mod$mods == "obese.0"] <- 16
warp_mod$mod_numb[warp_mod$mods == "obese.1"] <- 25
warp_mod$mod_numb[warp_mod$mods == "obese.2"] <- 13
warp_mod$mod_numb[warp_mod$mods == "obese.3"] <- 6
warp_mod$mod_numb[warp_mod$mods == "obese.4"] <- 9
warp_mod$mod_numb[warp_mod$mods == "obese.5"] <- 14
warp_mod$mod_numb[warp_mod$mods == "obese.6"] <- 8

head(warp_mod)

head(warp_mod)
warp_mod$visual <- NA
warp_mod[warp_mod$mods == 'no.0', "visual"] <- 'aBMI0'
warp_mod[warp_mod$mods == 'overweight.0', "visual"] <- 'hBMI0'
warp_mod[warp_mod$mods == 'obese.0', "visual"] <- 'vhBMI0'
head(warp_mod)
warp_mod<-warp_mod[!is.na(warp_mod$visual),]

head(warp_mod)

Mvis.PC0.gls <- gls(PC_sq ~ visual+mod_numb, data = warp_mod, na.action = na.omit)
Mvis.PC0.emm <- emmeans(Mvis.PC0.gls, "visual")

contrast(Mvis.PC0.emm, "pairwise",  adjust = "fdr")
eff_size(Mvis.PC0.emm, sigma = sigma(Mvis.PC0.gls), edf = 21)
```

```{r}
warp_mod$PC_z<-scale(warp_mod$PC)

warp_mod<-warp_mod[complete.cases(warp_mod$visual), ] 
VizPCp<-violin(warp_mod, warp_mod$visual, warp_mod$PC_z)
VizPCp

VizPCp<-ggplot(warp_mod, aes(visual, PC_z))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Participation Coefficient (z-score)")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))
```
### Sensory 
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))
warp_mod$PC_z<-scale(warp_mod$PC)

warp_mod$sensory <- NA
warp_mod[warp_mod$mods == 'no.2', "sensory"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.2', "sensory"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.4', "sensory"] <- 'vhBMI4'

Msen.PC0.gls <- gls(PC_sq ~ sensory, data = warp_mod, na.action = na.omit)
Msen.PC0.emm <- emmeans(Msen.PC0.gls, "sensory")

contrast(Msen.PC0.emm, "pairwise",  adjust = "fdr")
eff_size(Msen.PC0.emm, sigma = sigma(Msen.PC0.gls), edf = 21)
```

```{r}
warp_mod<-warp_mod[complete.cases(warp_mod$sensory), ] 
head(warp_mod)

SenPCp<-ggplot(warp_mod, aes(sensory, PC_z))+
  geom_violin(aes(fill = mods), draw_quantiles = c(0.25, 0.5, 0.75))+ 
  geom_jitter(height = 0, width = 0.1)+ 
  scale_fill_manual(values = cbPalette)+
  scale_y_continuous(name="Participation Coefficient (z-score)")+theme_classic()+
  theme(legend.position = "none")+
  scale_x_discrete(labels = c('aBMI','hBMI','vhBMI'))

SenPCp

PC_mod<-ggarrange(SenPCp, VizPCp,
          labels = c("Sensory", "Visual"),
                    ncol = 2)
```
### DMN
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$DMN <- NA
warp_mod[warp_mod$mods == 'no.1', "DMN"] <- 'aBMI1'
warp_mod[warp_mod$mods == 'overweight.1', "DMN"] <- 'hBMI1'
warp_mod[warp_mod$mods == 'obese.1', "DMN"] <- 'vhBMI1'

PC0.gls <- gls(PC_sq ~ DMN, data = warp_mod, na.action = na.omit)
PC0.emm <- emmeans(PC0.gls, "DMN")

contrast(PC0.emm, "pairwise",  adjust = "fdr")
```
### subcortical
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$subcort <- NA
warp_mod[warp_mod$mods == 'no.5', "subcort"] <- 'aBMI5'
warp_mod[warp_mod$mods == 'overweight.6', "subcort"] <- 'hBMI6'
warp_mod[warp_mod$mods == 'obese.6', "subcort"] <- 'vhBMI6'


PC0.gls <- gls(PC_sq ~ subcort, data = warp_mod, na.action = na.omit)
PC0.emm <- emmeans(PC0.gls, "subcort")

contrast(PC0.emm, "pairwise",  adjust = "fdr")
```
### other
```{r}
warp_mod <- transform(mdf, mods = interaction(group, module))

warp_mod$other <- NA
warp_mod[warp_mod$mods == 'no.3', "other"] <- 'aBMI2'
warp_mod[warp_mod$mods == 'overweight.3', "other"] <- 'hBMI2'
warp_mod[warp_mod$mods == 'obese.3', "other"] <- 'vhBMI4'


PC0.gls <- gls(PC_sq ~ other, data = warp_mod, na.action = na.omit)
PC0.emm <- emmeans(PC0.gls, "other")

contrast(PC0.emm, "pairwise",  adjust = "fdr")
```


# 3.7 Post Hoc Comparison with behavioral measures
## Data prep
```{r}
colnames(graph_df)
sub<-c("area","IC")
area<-graph_df[sub]
head(area)
df<-join(area, data)
```

```{r}
# mod
df$module<-as.factor(df$module)
summary(df$module)
module_df<-subset(df, df$module != 7)
module_df<-subset(module_df, module_df$module != 8)
module_df$module <- factor(module_df$module)
summary(module_df$module)
```
## Function 
```{r}
# y is behavioral measure
# x is the group
# z is the graph measures

fit_function<-function(x,y,z,data){
  x<-unlist(x)
  y <- unlist(y)
  z<-unlist(z)
  fit<-lm(y~z*x+Age_c+race_eth+Gender, data=data, na.action = na.omit)#
  return(fit)
}

library(splines)

spline_function<-function(x,y,z,data){
  x<-unlist(x)
  y <- unlist(y)
  z<-unlist(z)
  fit<-lm(y~ns(z, df =3)*x+Age_c+race_eth+Gender, data=data, na.action = na.omit)#
  return(fit)
}
```

modns <- lm(y ~ ns(x, df = 4))
plot(x, y)
lines(x, predict(modns))
## Participation coeff
### Auditory
```{r}
# View(module_df)
warp_1 <- transform(module_df, mods = interaction(group, area))
warp_1$PC_z<-scale(warp_1$PC)

warp_1$auditory <- NA
warp_1[warp_1$mods == 'no.Auditory', "auditory"] <- 'aBMIauditory'
warp_1[warp_1$mods == 'ov.Auditory', "auditory"] <- 'hBMIauditory'
warp_1[warp_1$mods == 'ob.Auditory', "auditory"] <- 'vhBMIauditory'
colnames(warp_1)
```


```{r}
# y is behavioral measure
# x is the group
# z is the graph measures
names<-colnames(warp_1[28:52])

aud <- list()
for (i in seq(28, 52, by= 1)){
  print(paste("start", i))
  out<-spline_function(x=warp_1[57], y = warp_1[i], z=warp_1[52], data = warp_1)
  test.emm <- emmeans(out, ~ ns(x, df =3)*z)
  df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
  EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
  aud[[i]] <-list(out, df, test.emm, EF)
}

aud2<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-aud[28:64][[i]][[2]]
  df$var<-names[i]
  aud2[[i]] <-list(df)
}

aud4<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-aud[28:64][[i]][[4]]
  df$var<-names[i]
  aud4[[i]] <-list(df)
}

df_PCaud<-bind_rows(aud2)
EF_PCaud<-bind_rows(aud4)

df_PCaud$contrast<-as.factor(df_PCaud$contrast)
EF_PCaud$contrast<-as.factor(EF_PCaud$contrast)
df_PCaud<-cbind(df_PCaud, EF_PCaud)

df_PCaud$pFDR<-p.adjust(df_PCaud$p.value, method = "BH")
df_PCaud
PC_auditory<-df_PCaud[df_PCaud$pFDR <= 0.05, ] 
PC_auditory
```


```{r}
warp_1<-warp_1[complete.cases(warp_1$auditory), ] 

tast_aud<-ggplot(warp_1, aes(x=PC_z, y=Taste_AgeAdj, color=auditory)) +
    geom_point(shape=1, alpha = 0.25) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()
tast_aud

DD40_aud<-ggplot(warp_1, aes(x=PC_z, y=DDisc_AUC_40K, color=auditory)) +
    geom_point(shape=1, alpha = 0.25) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()
DD40_aud

DD200_aud<-ggplot(warp_1, aes(x=PC_z, y=DDisc_AUC_200, color=auditory)) +
    geom_point(shape=1, alpha = 0.25) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()
DD200_aud
ggarrange(DD200_aud, DD40_aud, ncol = 2)
```

### somatosensory hand
```{r}
# View(module_df)
warp_1 <- transform(module_df, mods = interaction(group, area))
warp_1$PC_z<-scale(warp_1$PC)
warp_1$Smhand <- NA
warp_1[warp_1$mods == 'no.Smhand', "Smhand"] <- 'aBMISmhand'
warp_1[warp_1$mods == 'ov.Smhand', "Smhand"] <- 'hBMISmhand'
warp_1[warp_1$mods == 'ob.Smhand', "Smhand"] <- 'vhBMISmhand'
```


```{r}
# y is behavioral measure
# x is the group
# z is the graph measures
names<-colnames(warp_1[28:52])

smhand <- list()
for (i in seq(28, 52, by= 1)){
  print(paste("start", i))
  out<-spline_function(x=warp_1[57], y = warp_1[i], z=warp_1[52], data = warp_1)
  test.emm <- emmeans(out, ~ ns(x, df = 3)*z)
  df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
  EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
  smhand[[i]] <-list(out, df, test.emm, EF)
}

smhand2<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-smhand[28:64][[i]][[2]]
  df$var<-names[i]
  smhand2[[i]] <-list(df)
}

smhand4<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-smhand[28:64][[i]][[4]]
  df$var<-names[i]
  smhand4[[i]] <-list(df)
}

df_PCsmhand<-bind_rows(smhand2)
EF_PCsmhand<-bind_rows(smhand4)

df_PCsmhand$contrast<-as.factor(df_PCsmhand$contrast)
EF_PCsmhand$contrast<-as.factor(EF_PCsmhand$contrast)
df_PCsmhand<-cbind(df_PCsmhand, EF_PCsmhand)

df_PCsmhand$pFDR<-p.adjust(df_PCsmhand$p.value, method = "BH")
PC_smHand<-df_PCsmhand[df_PCsmhand$pFDR <= 0.05, ] 
PC_smHand
```

```{r}
#Working Memory (List Sorting)
#Cognitive Function Composite score
#Crystallized Cognition Composite score
warp_1$PC_z<-scale(warp_1$PC)
warp_1<-warp_1[complete.cases(warp_1$Smhand), ] 

PChand_DDisc_AUC_200<-ggplot(warp_1, aes(x=PC_z, y=DDisc_AUC_200, color=Smhand)) +
    geom_point(shape=1, alpha = 0.25) +    
    ylim(-3,3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()
dex
CFC<-ggplot(warp_1, aes(x=PC_z, y=CogTotalComp_AgeAdj, color=Smhand)) +
    geom_point(shape=1, alpha = 0.25) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()

Crystal<-ggplot(warp_1, aes(x=PC_z, y=CogCrystalComp_AgeAdj, color=Smhand)) +
    geom_point(shape=1, alpha = 0.25) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()
Crystal
ggarrange(dex, CFC, Crystal,
          ncol = 2, nrow = 2)
```
#### somatosensory mouth 
```{r}
# View(module_df)
warp_1 <- transform(module_df, mods = interaction(group, area))

warp_1$Smmouth <- NA
warp_1[warp_1$mods == 'no.Smmouth', "Smmouth"] <- 'aBMISmmouth'
warp_1[warp_1$mods == 'ov.Smmouth', "Smmouth"] <- 'hBMISmmouth'
warp_1[warp_1$mods == 'ob.Smmouth', "Smmouth"] <- 'vhBMISmmouth'
colnames(warp_1)
```


```{r}
# y is behavioral measure
# x is the group
# z is the graph measures
names<-colnames(warp_1[28:52])

smmouth <- list()
for (i in seq(28, 52, by= 1)){
  print(paste("start", i))
  out<-spline_function(x=warp_1[56], y = warp_1[i], z=warp_1[52], data = warp_1)
  test.emm <- emmeans(out, ~ ns(x, df = 3)*z)
  df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
  EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
  smmouth[[i]] <-list(out, df, test.emm, EF)
}

smmouth2<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-smmouth[28:64][[i]][[2]]
  df$var<-names[i]
  smmouth2[[i]] <-list(df)
}

smmouth4<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-smmouth[28:64][[i]][[4]]
  df$var<-names[i]
  smmouth4[[i]] <-list(df)
}

df_PCsmmouth<-bind_rows(smmouth2)
EF_PCsmmouth<-bind_rows(smmouth4)

df_PCsmmouth$contrast<-as.factor(df_PCsmmouth$contrast)
EF_PCsmmouth$contrast<-as.factor(EF_PCsmmouth$contrast)
df_PCsmmouth<-cbind(df_PCsmmouth, EF_PCsmmouth)

df_PCsmmouth$pFDR<-p.adjust(df_PCsmmouth$p.value, method = "BH")
df_PCsmmouth
PC_smmouth<-df_PCsmmouth[df_PCsmmouth$pFDR <= 0.05, ] 
PC_smmouth
```

```{r}
#Taste_AgeAdj
#ListSort_AgeAdj
#CogTotalComp_AgeAdj
warp_1$PC_z<-scale(warp_1$PC)
warp_1<-warp_1[complete.cases(warp_1$Smmouth), ] 

taste<-ggplot(warp_1, aes(x=PC_z, y=Endurance_AgeAdj, color=Smmouth)) +
    geom_point(shape=1, alpha = 0.25) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()
taste

WM<-ggplot(warp_1, aes(x=PC_z, y=ListSort_AgeAdj, color=Smmouth)) +
    geom_point(shape=1, alpha = 0.25) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()
WM

cog<-ggplot(warp_1, aes(x=PC_z, y=CogTotalComp_AgeAdj, color=Smmouth)) +
    geom_point(shape=1, alpha = 0.25) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()

ggarrange(taste, WM, cog,
          ncol = 2, nrow = 2)
```

#### visual
```{r}
warp_2 <- transform(module_df, mods = interaction(group, module))

warp_2$visual <- NA
warp_2[warp_2$mods == 'no.0', "visual"] <- 'aBMI0'
warp_2[warp_2$mods == 'ov.0', "visual"] <- 'hBMI0'
warp_2[warp_2$mods == 'ob.0', "visual"] <- 'vhBMI0'
#colnames(warp_2)
```

```{r}
# y is behavioral measure
# x is the group
# z is the graph measures
names<-colnames(warp_2[28:52])

vis <- list()
for (i in seq(28, 52, by= 1)){
  print(paste("start", i))
  out<-spline_function(x=warp_2[56], y = warp_2[i], z=warp_2[52], data = warp_2)
  test.emm <- emmeans(out, ~ ns(x, df = 3)*z)
  df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
  EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
  vis[[i]] <-list(out, df, test.emm, EF)
}

vis2<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-vis[28:64][[i]][[2]]
  df$var<-names[i]
  vis2[[i]] <-list(df)
}

vis4<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-vis[28:64][[i]][[4]]
  df$var<-names[i]
  vis4[[i]] <-list(df)
}

df_PCvis<-bind_rows(vis2)
EF_PCvis<-bind_rows(vis4)

df_PCvis$contrast<-as.factor(df_PCvis$contrast)
EF_PCvis$contrast<-as.factor(EF_PCvis$contrast)
df_PCvis<-cbind(df_PCvis, EF_PCvis)

df_PCvis$pFDR<-p.adjust(df_PCvis$p.value, method = "BH")
df_PCvis
PC_vis<-df_PCvis[df_PCvis$pFDR <= 0.00001, ] 
PC_vis
#write.table(PC_vis, "~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/just_vis_PC.csv", sep=",", row.names= F)
names(warp_2)

warp_2<-warp_2[complete.cases(warp_2$visual), ] 

ggplot(warp_2, aes(x=scale(PC), y=scale(DDisc_AUC_40K), color=visual)) + 
  geom_point(shape=1, alpha = 0.05) + 
  stat_smooth(method = lm, formula = y~ns(x,3), se=FALSE) + 
  theme_classic() + 
  scale_color_manual(values=cbPalette)+theme(legend.position = "none") 
warp_2$DDisc_AUC_40K
```

#### Sensory 
```{r}
warp_2 <- transform(module_df, mods = interaction(group, module))

warp_2$sensory <- NA
warp_2[warp_2$mods == 'no.2', "sensory"] <- 'aBMI2'
warp_2[warp_2$mods == 'ov.2', "sensory"] <- 'hBMI2'
warp_2[warp_2$mods == 'ob.4', "sensory"] <- 'vhBMI4'
colnames(warp_2)
```

```{r}
# y is behavioral measure
# x is the group
# z is the graph measures
names<-colnames(warp_2[28:52])

sensory <- list()
for (i in seq(28, 52, by= 1)){
  print(paste("start", i))
  out<-spline_function(x=warp_2[56], y = warp_2[i], z=warp_2[52], data = warp_2)
  test.emm <- emmeans(out, ~ ns(x, df = 3)*z)
  df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
  EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
  sensory[[i]] <-list(out, df, test.emm, EF)
}

sensory2<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-sensory[28:64][[i]][[2]]
  df$var<-names[i]
  sensory2[[i]] <-list(df)
}

sensory4<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-sensory[28:64][[i]][[4]]
  df$var<-names[i]
  sensory4[[i]] <-list(df)
}

df_PCsensory<-bind_rows(sensory2)
EF_PCsensory<-bind_rows(sensory4)

df_PCsensory$contrast<-as.factor(df_PCsensory$contrast)
EF_PCsensory$contrast<-as.factor(EF_PCsensory$contrast)
df_PCsensory<-cbind(df_PCsensory, EF_PCsensory)

df_PCsensory$pFDR<-p.adjust(df_PCsensory$p.value, method = "BH")
df_PCsensory
PC_sensory<-df_PCsensory[df_PCsensory$pFDR <= 0.00001, ] 
PC_sensory
write.table(PC_sensory, "~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/just_sen_PC.csv", sep=",", row.names= F)
```

```{r}
warp_2$PC_z<-scale(warp_2$PC)

warp_2<-warp_2[complete.cases(warp_2$sensory), ] 

DDisc_SV_1mo_200<-ggplot(warp_2, aes(x=PC_z, y=scale(DDisc_SV_1mo_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

DDisc_SV_6mo_200<-ggplot(warp_2, aes(x=PC_z, y=scale(DDisc_SV_6mo_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +  
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_1yr_200<-ggplot(warp_2, aes(x=PC_z, y=scale(DDisc_SV_1yr_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_5yr_200<-ggplot(warp_2, aes(x=PC_z, y=scale(DDisc_SV_5yr_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +    
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none")

DDisc_SV_10yr_200<-ggplot(warp_2, aes(x=PC_z, y=scale(DDisc_SV_10yr_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

PCsen_DDisc_AUC_200<-ggplot(warp_2, aes(x=PC_z, y=scale(DDisc_AUC_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

PCsen_end<-ggplot(warp_2, aes(x=PC_z, y=scale(Endurance_AgeAdj), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth() + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
PCsen_end

PCsen_taste<-ggplot(warp_2, aes(x=PC_z, y=scale(Taste_AgeAdj), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(ns(z, df =3)) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
PCsen_taste

ggplot(warp_2, aes(x=PC_z, y=scale(Endurance_AgeAdj), color=sensory)) + 
  geom_point(shape=1, alpha = 0.05) + 
  stat_smooth(method = lm, formula = y~ns(x,3), se=FALSE) + 
  theme_classic() + 
  scale_color_manual(values=cbPalette)+theme(legend.position = "none") 

warp_2$Endurance_AgeAdj

ggarrange(DDisc_SV_1mo_200, DDisc_SV_6mo_200,DDisc_SV_1yr_200, DDisc_SV_5yr_200,DDisc_SV_10yr_200,PCsen_DDisc_AUC_200,
          ncol = 2)

```

### Betweennness centrality 
#### visual
```{r}
warp_3 <- transform(module_df, mods = interaction(group, module))

warp_3$visual <- NA
warp_3[warp_3$mods == 'no.0', "visual"] <- 'aBMI0'
warp_3[warp_3$mods == 'ov.0', "visual"] <- 'hBMI0'
warp_3[warp_3$mods == 'ob.0', "visual"] <- 'vhBMI0'
colnames(warp_3)
```

```{r}
# y is behavioral measure
# x is the group
# z is the graph measures
names<-colnames(warp_3[28:52])

vis <- list()
for (i in seq(28, 52, by= 1)){
  print(paste("start", i))
  out<-fit_function(x=warp_3[56], y = warp_3[i], z=warp_3[53], data = warp_3)
  test.emm <- emmeans(out, ~ x*z)
  df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
  EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
  vis[[i]] <-list(out, df, test.emm, EF)
}

vis2<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-vis[28:64][[i]][[2]]
  df$var<-names[i]
  vis2[[i]] <-list(df)
}

vis4<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-vis[28:64][[i]][[4]]
  df$var<-names[i]
  vis4[[i]] <-list(df)
}

df_Cenvis<-bind_rows(vis2)
EF_Cenvis<-bind_rows(vis4)

df_Cenvis$contrast<-as.factor(df_Cenvis$contrast)
EF_Cenvis$contrast<-as.factor(EF_Cenvis$contrast)
df_Cenvis<-cbind(df_Cenvis, EF_Cenvis)

df_Cenvis$pFDR<-p.adjust(df_Cenvis$p.value, method = "BH")
df_Cenvis
Cen_vis<-df_Cenvis[df_Cenvis$pFDR <= 0.05, ] 
Cen_vis
```

```{r}
#  ListSort_AgeAdj
# CogTotalComp_AgeAdj
# DDisc_AUC_200
warp_3<-warp_3[complete.cases(warp_3$visual), ] 
names(warp_3)
WMvis<-ggplot(warp_3, aes(x=centrality, y= Endurance_AgeAdj, color=visual)) +
    geom_point(shape=1, alpha = 0.05) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()
WMvis
cogvis<-ggplot(warp_3, aes(x=centrality, y=CogTotalComp_AgeAdj, color=visual)) +
    geom_point(shape=1, alpha = 0.05) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()

ddvis<-ggplot(warp_3, aes(x=centrality, y=DDisc_AUC_40K, color=visual)) +
    geom_point(shape=1, alpha = 0.05) +    
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()

ggarrange(WMvis, cogvis, ddvis,
          ncol = 2, nrow = 2)
```

## Clustering coefficient 
#### Sensory 
```{r}
warp_X <- transform(module_df, mods = interaction(group, module))
levels(warp_X$mods)
warp_X$sensory <- NA
warp_X[warp_X$mods == "no.2", "sensory"] <- 'aBMI2'
warp_X[warp_X$mods == "ov.2", "sensory"] <- 'hBMI2'
warp_X[warp_X$mods == "ob.4", "sensory"] <- 'vhBMI4'
warp_X$sensory<-as.factor(warp_X$sensory)
```

```{r}
# y is behavioral measure
# x is the group
# z is the graph measures
names<-colnames(warp_X[28:52])

sensory <- list()
for (i in seq(28, 52, by= 1)){
  print(paste("start", i))
  out<-spline_function(x=warp_X[56], y = warp_X[i], z=warp_X[19], data = warp_X)
  test.emm <- emmeans(out, ~ ns(x, df =3)*z)
  df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
  EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
  sensory[[i]] <-list(out, df, test.emm, EF)
}

sensory2<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-sensory[28:64][[i]][[2]]
  df$var<-names[i]
  sensory2[[i]] <-list(df)
}

sensory4<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-sensory[28:64][[i]][[4]]
  df$var<-names[i]
  sensory4[[i]] <-list(df)
}

sensory1<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-summary(sensory[28:64][[i]][[1]])
  df$var<-names[i]
  sensory1[[i]] <-list(df)
}
sensory1[14]
names
df_CCsensory<-bind_rows(sensory2)
EF_CCsensory<-bind_rows(sensory4)

df_CCsensory$contrast<-as.factor(df_CCsensory$contrast)
EF_CCsensory$contrast<-as.factor(EF_CCsensory$contrast)
df_CCsensory<-cbind(df_CCsensory, EF_CCsensory)

df_CCsensory$pFDR<-p.adjust(df_CCsensory$p.value, method = "BH")
df_CCsensory
CC_sensory<-df_CCsensory[df_CCsensory$pFDR <= 0.05, ] 
CC_sensory
```

```{r}
head(warp_X)
fit<-lm(DDisc_AUC_200~clustering*sensory+Age_c+race_eth+Gender, data=warp_X, na.action = na.omit)#
summary(fit)
# test.emm <- emmeans(fit, ~ x*z)
# df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
# EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
sp_fit3<-lm(DDisc_AUC_200~ns(clustering, df = 3)*sensory+Age_c+race_eth+Gender, data=warp_X, na.action = na.omit)#
summary(sp_fit)
test.emm <- emmeans(sp_fit3, ~ ns(clustering, df = 3)*sensory)
df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
df
EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
EF

sp_fit4<-lm(DDisc_AUC_200~ns(clustering, df = 4)*sensory+Age_c+race_eth+Gender, data=warp_X, na.action = na.omit)#
summary(sp_fit4)

library(lmtest)
lrtest(fit, sp_fit)
anova(fit, sp_fit)
AIC(sp_fit4, sp_fit3)
```



```{r}
colnames(warp_X)
out<-fit_function(x=warp_X[56], y = warp_X[47], z=warp_X[19], data = warp_X)
out<-fit_function(x=warp_X$sensory, y = warp_X$ListSort_AgeAdj, z=warp_X$clustering, data = warp_X)
summary(out)
```

```{r}
warp_X<-warp_X[complete.cases(warp_X$sensory), ] 

CogCrystalComp_AgeAdj<-ggplot(warp_X, aes(x=clustering, y=scale(CogCrystalComp_AgeAdj), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +
    geom_smooth(method=lm) + 
    scale_color_manual(values=cbPalette)+ 
    theme_classic()+ theme(legend.position = "none")
CogCrystalComp_AgeAdj
```

# Delay discount 
```{r}
colnames(warp_X)
warp_X<-warp_X[complete.cases(warp_X$sensory), ] 

DDisc_SV_1mo_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_1mo_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

DDisc_SV_6mo_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_6mo_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +  
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_1yr_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_1yr_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_5yr_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_5yr_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +    
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none")

DDisc_SV_10yr_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_10yr_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

CCsen_DDisc_AUC_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_AUC_200), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

ggarrange(DDisc_SV_1mo_200, DDisc_SV_6mo_200,DDisc_SV_1yr_200, DDisc_SV_5yr_200,DDisc_SV_10yr_200,DDisc_AUC_200,
          ncol = 2)

```

```{r}
colnames(warp_X)
warp_X<-warp_X[complete.cases(warp_X$sensory), ] 

DDisc_SV_1mo_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_1mo_40K), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

DDisc_SV_6mo_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_6mo_40K), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +  
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_1yr_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_1yr_40K), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_5yr_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_5yr_40K), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +    
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none")

DDisc_SV_10yr_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_10yr_40K), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

DDisc_AUC_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_AUC_40K), color=sensory)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

ggarrange(DDisc_SV_1mo_40K, DDisc_SV_6mo_40K,DDisc_SV_1yr_40K, DDisc_SV_5yr_40K,DDisc_SV_10yr_40K,DDisc_AUC_40K,
          ncol = 2)

```

#### Subcortical 
```{r}
warp_X <- transform(module_df, mods = interaction(group, module))
levels(warp_X$mods)
warp_X$subcortical <- NA
warp_X[warp_X$mods == "no.5", "subcortical"] <- 'aBMI5'
warp_X[warp_X$mods == "ov.6", "subcortical"] <- 'hBMI6'
warp_X[warp_X$mods == "ob.6", "subcortical"] <- 'vhBMI6'
warp_X$subcortical<-as.factor(warp_X$subcortical)
```

```{r}
# y is behavioral measure
# x is the group
# z is the graph measures
names<-colnames(warp_X[28:52])

subcortical <- list()
for (i in seq(28, 52, by= 1)){
  print(paste("start", i))
  out<-spline_function(x=warp_X[56], y = warp_X[i], z=warp_X[19], data = warp_X)
  test.emm <- emmeans(out, ~ ns(x, df =3)*z)
  df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
  EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
  subcortical[[i]] <-list(out, df, test.emm, EF)
}

subcortical2<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-subcortical[28:64][[i]][[2]]
  df$var<-names[i]
  subcortical2[[i]] <-list(df)
}

subcortical4<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-subcortical[28:64][[i]][[4]]
  df$var<-names[i]
  subcortical4[[i]] <-list(df)
}

df_CCsubcortical<-bind_rows(subcortical2)
EF_CCsubcortical<-bind_rows(subcortical4)

df_CCsubcortical$contrast<-as.factor(df_CCsubcortical$contrast)
EF_CCsubcortical$contrast<-as.factor(EF_CCsubcortical$contrast)
df_CCsubcortical<-cbind(df_CCsubcortical, EF_CCsubcortical)

df_CCsubcortical$pFDR<-p.adjust(df_CCsubcortical$p.value, method = "BH")
df_CCsubcortical
CC_subcortical<-df_CCsubcortical[df_CCsubcortical$pFDR <= 0.05, ] 
CC_subcortical
```


```{r}
warp_X<-warp_X[complete.cases(warp_X$subcortical), ] 

CogCrystalComp_AgeAdj<-ggplot(warp_X, aes(x=clustering, y=scale(CogCrystalComp_AgeAdj), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +
    geom_smooth(method=lm) + 
    scale_color_manual(values=cbPalette)+ 
    theme_classic()+ theme(legend.position = "none")
CogCrystalComp_AgeAdj
```

"DDisc_SV_1mo_40K"      "DDisc_SV_6mo_40K"      "DDisc_SV_1yr_40K"     
[37] "DDisc_SV_3yr_40K"      "DDisc_SV_5yr_40K"      "DDisc_SV_10yr_40K"     "DDisc_AUC_200"        
[41] "DDisc_AUC_40K" 
```{r}
colnames(warp_X)
warp_X<-warp_X[complete.cases(warp_X$subcortical), ] 

DDisc_SV_1mo_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_1mo_40K), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

DDisc_SV_6mo_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_6mo_40K), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +  
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_1yr_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_1yr_40K), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_5yr_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_5yr_40K), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +    
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none")

DDisc_SV_10yr_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_10yr_40K), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

CCsub_DDisc_AUC_40K<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_AUC_40K), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

ggarrange(DDisc_SV_1mo_40K, DDisc_SV_6mo_40K,DDisc_SV_1yr_40K, DDisc_SV_5yr_40K,DDisc_SV_10yr_40K,DDisc_AUC_40K,
          ncol = 2)

```

```{r}
colnames(warp_X)
warp_X<-warp_X[complete.cases(warp_X$subcortical), ] 

DDisc_SV_1mo_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_1mo_200), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

DDisc_SV_6mo_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_6mo_200), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +  
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_1yr_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_1yr_200), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 
DDisc_SV_5yr_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_5yr_200), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +    
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none")

DDisc_SV_10yr_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_SV_10yr_200), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

CCsub_DDisc_AUC_200<-ggplot(warp_X, aes(x=clustering, y=scale(DDisc_AUC_200), color=subcortical)) +
    geom_point(shape=1, alpha = 0.05) +   
    ylim(-3, 3)+
    geom_smooth(method=lm) + scale_color_manual(values=cbPalette)+ theme_classic()+ theme(legend.position = "none") 

ggarrange(DDisc_SV_1mo_200, DDisc_SV_6mo_200,DDisc_SV_1yr_200, DDisc_SV_5yr_200,DDisc_SV_10yr_200,DDisc_AUC_200,
          ncol = 2)

```


###  Combine the tables
Keep the contrast, t-ratio, SE, var, pFDR, metric, area
Round to 2 decimal places
Add area and type 
```{r}
df_func<-function(df, m, a){
  keep<-c("metric","area","Contrast","Var","effect.size","SE","pFDR")
  round2<-c("effect.size","SE","t.ratio")
  round3<-c("pFDR")
  df$metric<-sprintf("%s", m)
  df$area<- sprintf("%s", a)
  df[round2]<-round(df[round2], 2)
  df[round3]<-round(df[round3], 3)
  
  df$contrast<-gsub('[[:digit:]]+', '', df$contrast)
  df$Contrast<-NA
  df[df$contrast == "aBMI,. - hBMI,.", "Contrast"] <- 'aBMI vs. hBMI'
  df[df$contrast == "aBMI,. - vhBMI,.", "Contrast"] <- 'aBMI vs. vhBMI'
  df[df$contrast == "hBMI,. - vhBMI,.", "Contrast"] <- 'hBMI vs. vhBMI'
  
  df[df$contrast == "aBMISmhand,. - hBMISmhand,.", "Contrast"] <- 'aBMI vs. hBMI'
  df[df$contrast == "aBMISmhand,. - vhBMISmhand,.", "Contrast"] <- 'aBMI vs. vhBMI'
  df[df$contrast == "hBMISmhand,. - vhBMISmhand,.", "Contrast"] <- 'hBMI vs. vhBMI'
  
  df[df$contrast == "aBMISmmouth,. - hBMISmmouth,.", "Contrast"] <- 'aBMI vs. hBMI'
  df[df$contrast == "aBMISmmouth,. - vhBMISmmouth,.", "Contrast"] <- 'aBMI vs. vhBMI'
  df[df$contrast == "hBMISmmouth,. - vhBMISmmouth,.", "Contrast"] <- 'hBMI vs. vhBMI'
  
  df[df$contrast == "aBMIauditory,. - hBMIauditory,.", "Contrast"] <- 'aBMI vs. hBMI'
  df[df$contrast == "aBMIauditory,. - vhBMIauditory,.", "Contrast"] <- 'aBMI vs. vhBMI'
  df[df$contrast == "hBMIauditory,. - vhBMIauditory,.", "Contrast"] <- 'hBMI vs. vhBMI'
  
  df$Var<-NA
  df[df$var == "CogCrystalComp_AgeAdj", "Var"] <- 'Crystallized Cognition Composite score'
  df[df$var == "CogEarlyComp_AgeAdj", "Var"] <- 'Early Childhood Composite score'
  df[df$var == "CogFluidComp_AgeAdj", "Var"] <- 'Fluid Cognition Composite score'
  df[df$var == "CogTotalComp_AgeAdj", "Var"] <- 'Cognitive Function Composite score'
  df[df$var == "DDisc_AUC_200", "Var"] <- 'Delay Discounting: Area Under the Curve (AUC) for Discounting of $200'
  df[df$var == "DDisc_AUC_40K", "Var"] <- 'Delay Discounting: Area Under the Curve (AUC) for Discounting of $40,000'
  df[df$var == "DDisc_SV_10yr_200", "Var"] <- 'Delay Discounting: Subjective Value for $200 at 10 years'
  df[df$var == "DDisc_SV_10yr_40K", "Var"] <- 'Delay Discounting: Subjective Value for $40,000 at 10 years'
  df[df$var == "DDisc_SV_1mo_200", "Var"] <- 'Delay Discounting: Subjective Value for $200 at 1 month'
  df[df$var == "DDisc_SV_1mo_40K", "Var"] <- 'Delay Discounting: Subjective Value for $40,000 at 1 month'
  df[df$var == "DDisc_SV_1yr_200", "Var"] <- 'Delay Discounting: Subjective Value for $200 at 1 year'
  df[df$var == "DDisc_SV_1yr_40K", "Var"] <- 'Delay Discounting: Subjective Value for $40,000 at 1 year'
  df[df$var == "DDisc_SV_3yr_200", "Var"] <- 'Delay Discounting: Subjective Value for $200 at 3 year'
  df[df$var == "DDisc_SV_3yr_40K", "Var"] <- 'Delay Discounting: Subjective Value for $40,000 at 3 year'
  df[df$var == "DDisc_SV_5yr_200", "Var"] <- 'Delay Discounting: Subjective Value for $200 at 5 year'
  df[df$var == "DDisc_SV_5yr_40K", "Var"] <- 'Delay Discounting: Subjective Value for $40,000 at 5 year'
  df[df$var == "DDisc_SV_6mo_200", "Var"] <- 'Delay Discounting: Subjective Value for $200 at 6 months'
  df[df$var == "DDisc_SV_6mo_40K", "Var"] <- 'Delay Discounting: Subjective Value for $40,000 at 6 months'
  df[df$var == "Dexterity_AgeAdj", "Var"] <- 'Dexterity'
  df[df$var == "Endurance_AgeAdj", "Var"] <- 'Endurance'
  df[df$var == "GaitSpeed_Comp", "Var"] <- 'Gait Speed'
  df[df$var == "ListSort_AgeAdj", "Var"] <- 'Working Memory (List Sorting)'
  df[df$var == "Strength_AgeAdj", "Var"] <- 'Strength'
  df[df$var == "Taste_AgeAdj", "Var"] <- 'Taste sensitivity'
  df<-df[keep]
  return(df)
}
```

```{r}
colnames(PC_auditory)<-c("contrast", "estimate","noSE", "nodf", "t.ratio", "p.value", "no_var", "nocontrast","effect.size","SE", "df", "lower.CL",    "upper.CL", "var","pFDR")
colnames(PC_smHand)<-c("contrast", "estimate","noSE", "nodf", "t.ratio", "p.value", "no_var", "nocontrast","effect.size","SE", "df", "lower.CL",    "upper.CL", "var","pFDR")
colnames(PC_smmouth)<-c("contrast", "estimate","noSE", "nodf", "t.ratio", "p.value", "no_var", "nocontrast","effect.size","SE", "df", "lower.CL",    "upper.CL", "var","pFDR")
colnames(Cen_vis)<-c("contrast", "estimate","noSE", "nodf", "t.ratio", "p.value", "no_var", "nocontrast","effect.size","SE", "df", "lower.CL",    "upper.CL", "var","pFDR")
colnames(CC_subcortical)<-c("contrast", "estimate","noSE", "nodf", "t.ratio", "p.value", "no_var", "nocontrast","effect.size","SE", "df", "lower.CL",    "upper.CL", "var","pFDR")
colnames(PC_sensory)<-c("contrast", "estimate","noSE", "nodf", "t.ratio", "p.value", "no_var", "nocontrast","effect.size","SE", "df", "lower.CL",    "upper.CL", "var","pFDR")

```



```{r}
PC_sensory2<-df_func(df = PC_sensory, m = "participation coefficient", a = "sensory module")
CC_sensory2<-df_func(df = CC_sensory, m = "clustering coefficient", a = "sensory module")
PC_auditory2<-df_func(df = PC_auditory, m = "participation coefficient", a ="auditory functional network")
PC_hand2<-df_func(df = PC_smHand, m = "participation coefficient", a = "somatosensory hand functional network")
PC_mouth2<-df_func(df = PC_smmouth, m = "participation coefficient",  a = "somatosensory mouth functional network")
CEN_visualmod2<-df_func(df = Cen_vis, m = "betweenness centrality", a = "visual module")
CC_subcortical2<-df_func(df = CC_subcortical, m = "clustering coefficient", a = "subcortical module")
```



```{r}
all_df<-rbind(CC_subcortical2, CC_sensory2, PC_auditory2, PC_hand2, PC_mouth2, PC_sensory2 ,CEN_visualmod2)
colz<-c("Metric","Area", "Contrast", "Behavioral variable", "effect.size","SE","pFDR")
colnames(all_df)<-colz
all_df$`Behavioral variable`<-as.factor(all_df$`Behavioral variable`)
all_df
```


```{r}
write.table(all_df, "~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/spline_post_hoc.csv", sep=",", row.names = F)
```

## Testing edges 
```{r}
mod_edge_df$source<-as.factor(mod_edge_df$source)
mod_edge_df$target<-as.factor(mod_edge_df$target)


edf<-subset(mod_edge_df, mod_edge_df$source != 7)
edf<-subset(edf, edf$source != 8)
edf<-subset(edf, edf$target != 7)
edf<-subset(edf, edf$target != 8)

edf$source<-factor(edf$source)
edf$target<-factor(edf$target)

summary(edf$source)
summary(edf$target)
```

```{r}
warp_edges <- transform(edf, mods = interaction(group, source, target))
head(warp_edges)
# no.2.5 vs. ov.2.6 vs. ob.4.6
warp_edges$newvar <- NA
warp_edges[warp_edges$mods == 'no.2.5', "newvar"] <- 'aBMI'
warp_edges[warp_edges$mods == 'ov.2.6', "newvar"] <- 'hBMI'
warp_edges[warp_edges$mods == 'ob.4.6', "newvar"] <- 'vhBMI'

summary(as.factor(warp_edges$newvar))
head(warp_edges)
warp_edges$newvar<-as.factor(warp_edges$newvar)
levels(warp_edges$newvar)
warp_spec<-warp_edges[complete.cases(warp_edges), ]
head(warp_spec)
warp_spec$mods<-factor(warp_spec$mods)
levels(warp_spec$mods)
```





```{r}
head(edge_df)
head(edf)
head(mod_edge_df)
colnames(data)
data<-as_tibble(data)
colnames(data)
head(data)
# Compute the mean of multiple columns
data[29:51] <- sapply(data[29:51], as.factor)

data %<>%
       group_by(group) %>%
       mutate_at(vars(data[,29:51]), numeric)
       
summarise_at(vars(data[,29:51]), list(mean=mean, sd=sd))


data %>%
  group_by(group) %>%
  summarise(across("DDisc_SV_1yr_200":"Taste_AgeAdj", mean, na.rm= TRUE))
```




```{r}
warp_spec <- transform(warp_spec, mods = interaction(group, source, target))
warp_spec$mods<-factor(warp_spec$mods)
levels(warp_spec$mods)
head(warp_spec)
zW1.gls <- gls(z_weight ~ newvar, data = warp_spec)
zW1.emm <- emmeans(zW1.gls, "newvar")

contrast(zW1.emm, "pairwise",  adjust = "fdr")
eff_size(zW1.emm, sigma = sigma(zW1.gls), edf = 340, method = "pairwise")

violin(warp_spec, warp_spec$newvar, warp_spec$z_weight)
```


```{r}
describeBy(warp_spec$z_weight, warp_spec$newvar)
```


```{r}
warp_edges <- transform(edf, mods = interaction(group, source, target))
head(warp_edges)
levels(warp_edges$mods)
zW.gls <- gls(z_weight ~ mods, data = warp_edges)
zW.emm <- emmeans(zW.gls, "mods")
zW.fac <- update(zW.emm, levels = list(
                group = c("no", "ov", "ob"), 
                edge = c("0.1","0.2","0.3","0.4", "0.5", "0.6", 
                         "1.2","1.3","1.4","1.5","1.6",
                         "2.3","2.4","2.5","2.6",
                         "3.4","3.5","3.6",
                         "4.5","4.6",
                         "5.6")))
total <- contrast(zW.fac, "pairwise", by = "edge", adjust = "fdr")
total<-data.frame(total)
keep<-c("contrast", "edge", "p.value")
total<-total[keep]
total_eff<-eff_size(zW.fac, sigma = sigma(zW.gls), edf = 7140, method = "pairwise", by = "edge")
total_eff<-data.frame(total_eff)
head(total_eff)
kepp<-c("contrast", "edge", "effect.size" ,"SE")
total_eff<-total_eff[kepp]
total_edge<-cbind(total, total_eff)
head(warp_edges)
```

```{r}
violin <- function(d, x, y){
  plot1<-ggplot(d, aes(factor(x), y)) + 
    geom_violin(aes(fill = x),stat = "ydensity",draw_quantiles = c(0.25, 0.5, 0.75))+scale_fill_manual(values=cbPalette)+theme_classic()
  return(plot1)
}

t<-subset(warp_edges, warp_edges$source == 0)
tt<-subset(t, t$target == 3)

head(tt)
violin(tt, tt$group, tt$z_weight)
```

```{r}
vars<-c("contrast", "edge","effect.size ","SE", "p.value")
r2<-c("effect.size","SE")
r3<-c("p.value")

total_edge<-total_edge[vars]
total_edge[r2]<-round(total_edge[r2], 2)
total_edge[r3]<-round(total_edge[r3], 3)

levels(total_edge$contrast)
total_edge$Contrast <- NA
total_edge[total_edge$contrast == "no - ov", "Contrast"] <- 'aBMI vs. hBMI'
total_edge[total_edge$contrast == "no - ob", "Contrast"] <- 'aBMI vs. vhBMI'
total_edge[total_edge$contrast == "ov - ob", "Contrast"] <- 'hBMI vs. vhBMI'
keep<-c("edge","Contrast","effect.size","SE", "p.value")   
total_edge<-total_edge[keep]
head(total_edge)
#write.table(total_edge, "~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/edges_table.csv", sep=",", row.names = F)
```

### Post hoc edges
```{r}
warp_edges <- transform(edf, mods = interaction(group, source, target))
head(warp_edges)
# no.2.5 vs. ov.2.6 vs. ob.4.6
warp_edges$newvar <- NA
warp_edges[warp_edges$mods == 'no.2.5', "newvar"] <- 'aBMI'
warp_edges[warp_edges$mods == 'ov.2.6', "newvar"] <- 'hBMI'
warp_edges[warp_edges$mods == 'ob.4.6', "newvar"] <- 'vhBMI'

warp_edges$newvar<-as.factor(warp_edges$newvar)
warp_spec<-warp_edges[complete.cases(warp_edges), ]
warp_spec$mods<-factor(warp_spec$mods)
```


```{r}
# y is behavioral measure
# x is the group
# z is the graph measures
names<-colnames(warp_spec[28:52])

subcortical <- list()
for (i in seq(28, 52, by= 1)){
  print(paste("start", i))
  out<-fit_function(x=warp_X[56], y = warp_X[i], z=warp_X[19], data = warp_X)
  test.emm <- emmeans(out, ~ x*z)
  df<-data.frame(contrast(test.emm, "pairwise",  adjust = "fdr"))
  EF <- data.frame(eff_size(test.emm, sigma = sigma(out), edf = 526, method = "pairwise"))
  subcortical[[i]] <-list(out, df, test.emm, EF)
}

subcortical2<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-subcortical[28:64][[i]][[2]]
  df$var<-names[i]
  subcortical2[[i]] <-list(df)
}

subcortical4<-list()
for(i in seq(1, 24, by = 1)){
  print(paste ("this is ",i))
  df<-subcortical[28:64][[i]][[4]]
  df$var<-names[i]
  subcortical4[[i]] <-list(df)
}

df_CCsubcortical<-bind_rows(subcortical2)
EF_CCsubcortical<-bind_rows(subcortical4)

df_CCsubcortical$contrast<-as.factor(df_CCsubcortical$contrast)
EF_CCsubcortical$contrast<-as.factor(EF_CCsubcortical$contrast)
df_CCsubcortical<-cbind(df_CCsubcortical, EF_CCsubcortical)

df_CCsubcortical$pFDR<-p.adjust(df_CCsubcortical$p.value, method = "BH")
df_CCsubcortical
CC_subcortical<-df_CCsubcortical[df_CCsubcortical$pFDR <= 0.05, ] 
CC_subcortical
```

```{r}
save.image("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/HCPcheck.RData")
```

```{r}
unique(no$subject)
```

```{r}
no<-subset(data, data$group == "no")
no$subject<-factor(no$subject)
unique(no$subject) #156
no$group<-factor(no$group)
module2_no<-subset(no, no$modules == "2")
no$modules<-factor(no$modules)
colnames(no)
no_mod2<-data.frame(summary(no$IC))
head(no_mod2)
156*.9
setDT(no_mod2, keep.rownames = TRUE)[]
no_mod2[no_mod2$summary.no.IC. > 140]
```

# Summary of what IC is in which module and functional group
```{r}
colnames(graph_df)
levels(graph_df$group)
nos<- subset(graph_df, graph_df$group == "no")
test<-table(nos$module, nos$IC, nos$area, nos$node_type)
test<-data.frame(test)
head(test)
tes<-subset(test, test$Freq == 1)
write.table(tes, "~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/no_freq.csv", sep=",", row.names = F)

ovs<- subset(graph_df, graph_df$group == "overweight")
test<-table(ovs$module, ovs$IC, ovs$area, ovs$node_type)
test<-data.frame(test)
head(test)
tes<-subset(test, test$Freq == 1)
write.table(tes, "~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/ov_freq.csv", sep=",", row.names = F)

obs<- subset(graph_df, graph_df$group == "obese")
test<-table(obs$module, obs$IC, obs$area, obs$node_type)
test<-data.frame(test)
head(test)
tes<-subset(test, test$Freq == 1)
write.table(tes, "~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/ob_freq.csv", sep=",", row.names = F)
```




```{r}
load("~/Google Drive/HCP/HCP_graph/1200/datasets/tmp/HCPcheck.RData")
```

